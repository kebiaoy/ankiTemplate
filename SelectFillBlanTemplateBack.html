<script>
    // v1.1.8 - https://github.com/SimonLammer/anki-persistence/blob/584396fea9dea0921011671a47a0fdda19265e62/script.js
    if(void 0===window.Persistence){var e="github.com/SimonLammer/anki-persistence/",t="_default";if(window.Persistence_sessionStorage=function(){var i=!1;try{"object"==typeof window.sessionStorage&&(i=!0,this.clear=function(){for(var t=0;t<sessionStorage.length;t++){var i=sessionStorage.key(t);0==i.indexOf(e)&&(sessionStorage.removeItem(i),t--)}},this.setItem=function(i,n){void 0==n&&(n=i,i=t),sessionStorage.setItem(e+i,JSON.stringify(n))},this.getItem=function(i){return void 0==i&&(i=t),JSON.parse(sessionStorage.getItem(e+i))},this.removeItem=function(i){void 0==i&&(i=t),sessionStorage.removeItem(e+i)},this.getAllKeys=function(){for(var t=[],i=Object.keys(sessionStorage),n=0;n<i.length;n++){var s=i[n];0==s.indexOf(e)&&t.push(s.substring(e.length,s.length))}return t.sort()})}catch(n){}this.isAvailable=function(){return i}},window.Persistence_windowKey=function(i){var n=window[i],s=!1;"object"==typeof n&&(s=!0,this.clear=function(){n[e]={}},this.setItem=function(i,s){void 0==s&&(s=i,i=t),n[e][i]=s},this.getItem=function(i){return void 0==i&&(i=t),void 0==n[e][i]?null:n[e][i]},this.removeItem=function(i){void 0==i&&(i=t),delete n[e][i]},this.getAllKeys=function(){return Object.keys(n[e])},void 0==n[e]&&this.clear()),this.isAvailable=function(){return s}},window.Persistence=new Persistence_sessionStorage,Persistence.isAvailable()||(window.Persistence=new Persistence_windowKey("py")),!Persistence.isAvailable()){var i=window.location.toString().indexOf("title"),n=window.location.toString().indexOf("main",i);i>0&&n>0&&n-i<10&&(window.Persistence=new Persistence_windowKey("qt"))}}
</script>

<style>
    .select-blank {
        display: inline-block;
        min-width: 50px;
        max-width: 120px;
        padding: 2px 6px;
        border: 2px solid #4A90E2;
        border-radius: 4px;
        background-color: #f8f9fa;
        cursor: default;
        text-align: center;
        position: relative;
        height: 24px;
        line-height: 20px;
        margin: 0 1px;
        font-size: 14px;
        vertical-align: middle;
    }

    .input-blank {
        display: inline-block;
        min-width: 60px;
        max-width: 150px;
        width: auto;
        padding: 2px 6px;
        border: none;
        border-bottom: 2px solid #4A90E2;
        border-radius: 0;
        background-color: transparent;
        font-size: 14px;
        height: 24px;
        line-height: 20px;
        margin: 0 1px;
        vertical-align: middle;
        box-sizing: border-box;
        cursor: default;
    }

    .input-blank:disabled {
        background-color: transparent;
        cursor: default;
        opacity: 1; /* ä¿æŒæ¸…æ™°æ˜¾ç¤º */
        color: #333; /* ç¡®ä¿æ–‡å­—æ¸…æ™°å¯è§ */
    }

    .number-input {
        text-align: center;
    }

    /* æ­£ç¡®ç­”æ¡ˆæ ·å¼ */
    .correct {
        border-bottom-color: #4CAF50 !important;
        background-color: #e8f5e8 !important;
    }

    /* é”™è¯¯ç­”æ¡ˆæ ·å¼ */
    .incorrect {
        border-bottom-color: #f44336 !important;
        background-color: #ffebee !important;
    }

    .question-container {
        font-size: 16px;
        line-height: 1.6;
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fafafa;
    }



    .analysis-section {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ff9800;
        border-radius: 8px;
        background-color: #fff8e1;
    }

    .analysis-title {
        font-weight: bold;
        color: #e65100;
        margin-bottom: 10px;
        font-size: 16px;
    }

    .answer-comparison {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #2196F3;
        border-radius: 8px;
        background-color: #e3f2fd;
    }

    .comparison-title {
        font-weight: bold;
        color: #1976D2;
        margin-bottom: 15px;
        font-size: 16px;
    }

    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .comparison-table th,
    .comparison-table td {
        border: 1px solid #ddd;
        padding: 8px 12px;
        text-align: left;
    }

    .comparison-table th {
        background-color: #f5f5f5;
        font-weight: bold;
    }

    .comparison-table .correct-answer {
        color: #4CAF50;
        font-weight: bold;
    }

    .comparison-table .wrong-answer {
        color: #f44336;
        font-weight: bold;
    }

    .comparison-table .status-correct {
        color: #4CAF50;
        font-weight: bold;
    }

    .comparison-table .status-wrong {
        color: #f44336;
        font-weight: bold;
    }

    .success-message {
        margin-top: 20px;
        padding: 15px;
        border: 2px solid #4CAF50;
        border-radius: 8px;
        background-color: #e8f5e8;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        color: #2e7d32;
    }

    .success-icon {
        font-size: 24px;
        margin-right: 8px;
    }

    .debug-info {
        margin-top: 20px;
        padding: 10px;
        background-color: #f0f0f0;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
    }

    .debug-input {
        width: 100%;
        padding: 5px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-family: monospace;
        font-size: 12px;
    }

    .debug-output {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 5px;
        background-color: white;
        white-space: pre-wrap;
    }

</style>

{{FrontSide}}
<div id="back-content"></div>
<!--<div id="debug" class="debug-info">-->
<!--    <input type="text" id="debug-input" class="debug-input" placeholder="è¾“å…¥è°ƒè¯•æ–‡æœ¬ï¼ŒæŒ‰å›è½¦æ·»åŠ ">-->
<!--    <div id="debug-output" class="debug-output"></div>-->
<!--</div>-->
<script>
    let result = Persistence.getItem('SelectInResult');
    addDebugText(JSON.stringify(Persistence.getItem('SelectInResult')));
    addDebugText(`{{Answer}}`.trim());
    // å…¨å±€å˜é‡
    let userAnswers = [];
    let correctAnswers = [];
    let hasErrors = false;

    // è§£æç”¨æˆ·ç­”æ¡ˆï¼ˆä»SelectInResultï¼‰
    function parseUserAnswers(selectInResult) {
        if (!selectInResult || !Array.isArray(selectInResult)) {
            return [];
        }

        // æŒ‰ç…§indexæ’åºï¼Œç¡®ä¿é¡ºåºæ­£ç¡®
        const sortedResults = selectInResult.sort((a, b) => a.index - b.index);

        return sortedResults.map(result => {
            if (result.type === 'select') {
                if (result.SelectValue && result.SelectValue.length > 0) {
                    // å°†ç´¢å¼•è½¬æ¢ä¸ºå­—æ¯ï¼ˆ0=A, 1=B, 2=C...ï¼‰
                    return result.SelectValue.map(index => String.fromCharCode(65 + index)).join('');
                } else {
                    return '';
                }
            } else if (result.type === 'number' || result.type === 'text') {
                return result.value || '';
            }
            return '';
        });
    }

    // è§£ææ­£ç¡®ç­”æ¡ˆï¼ˆä»HTMLæ ¼å¼ï¼‰
    function parseCorrectAnswers(answerHtml) {
        if (!answerHtml || !answerHtml.trim()) {
            return [];
        }

        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„DOMå…ƒç´ æ¥è§£æHTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = answerHtml.trim();

        // è·å–æ‰€æœ‰çš„pæ ‡ç­¾
        const pTags = tempDiv.querySelectorAll('p');
        const answers = [];

        for (let i = 0; i < pTags.length; i++) {
            const text = pTags[i].textContent.trim();
            answers.push(text);
        }

        return answers;
    }

    // æ¯”è¾ƒç­”æ¡ˆ
    function compareAnswers(userAnswer, correctAnswer) {
        if (!userAnswer && !correctAnswer) return true;
        if (!userAnswer || !correctAnswer) return false;

        // å¯¹äºé€‰æ‹©é¢˜ï¼Œæ¯”è¾ƒå­—æ¯ç»„åˆ
        if (typeof userAnswer === 'string' && typeof correctAnswer === 'string') {
            // å»é™¤ç©ºæ ¼å¹¶è½¬æ¢ä¸ºå¤§å†™è¿›è¡Œæ¯”è¾ƒ
            const normalizedUser = userAnswer.replace(/\s/g, '').toUpperCase();
            const normalizedCorrect = correctAnswer.replace(/\s/g, '').toUpperCase();
            return normalizedUser === normalizedCorrect;
        }

        return String(userAnswer) === String(correctAnswer);
    }

    // é€šè¿‡IDè·å–è¾“å…¥æ¡†å¹¶è®¾ç½®ä¸ºåªè¯»ï¼ŒåŒæ—¶è®¾ç½®æ­£ç¡®/é”™è¯¯æ ·å¼
    function setInputBoxesReadOnly() {
        addDebugText('å¼€å§‹è®¾ç½®è¾“å…¥æ¡†ä¸ºåªè¯»çŠ¶æ€...');

        let inputIndex = 0;
        while (true) {
            const inputElement = document.getElementById(`input-${inputIndex}`);
            if (!inputElement) {
                break; // æ²¡æœ‰æ›´å¤šè¾“å…¥æ¡†äº†
            }

            // è·å–ç”¨æˆ·ç­”æ¡ˆå’Œæ­£ç¡®ç­”æ¡ˆ
            const userAnswer = userAnswers[inputIndex] || '';
            const correctAnswer = correctAnswers[inputIndex] || '';
            const isCorrect = compareAnswers(userAnswer, correctAnswer);

            // è®¾ç½®ä¸ºåªè¯»çŠ¶æ€
            if (inputElement.tagName === 'INPUT') {
                // å¯¹äºinputå…ƒç´ 
                inputElement.readOnly = true;
                inputElement.disabled = true;
                inputElement.style.pointerEvents = 'none';
                inputElement.style.cursor = 'default';

                // è®¾ç½®ç”¨æˆ·ç­”æ¡ˆ
                inputElement.value = userAnswer || '';
            } else if (inputElement.tagName === 'SPAN') {
                // å¯¹äºspanå…ƒç´ ï¼ˆé€‰æ‹©æ¡†ï¼‰
                inputElement.style.pointerEvents = 'none';
                inputElement.style.cursor = 'default';
                inputElement.onclick = null; // ç§»é™¤ç‚¹å‡»äº‹ä»¶

                // è®¾ç½®ç”¨æˆ·ç­”æ¡ˆ
                inputElement.textContent = userAnswer || '(æœªä½œç­”)';
            }

            // è®¾ç½®æ­£ç¡®/é”™è¯¯æ ·å¼
            inputElement.classList.remove('correct', 'incorrect');
            if (isCorrect) {
                inputElement.classList.add('correct');
            } else {
                inputElement.classList.add('incorrect');
                hasErrors = true;
            }

            addDebugText(`è¾“å…¥æ¡†${inputIndex}: ${userAnswer} ${isCorrect ? 'âœ“' : 'âœ—'} (æ­£ç¡®ç­”æ¡ˆ: ${correctAnswer})`);
            inputIndex++;
        }

                addDebugText(`å…±å¤„ç†äº† ${inputIndex} ä¸ªè¾“å…¥æ¡†`);
        
        // æ˜¾ç¤ºè§£ææˆ–æˆåŠŸä¿¡æ¯
        showAnalysis();
    }

    // åˆ›å»ºç­”æ¡ˆæ¯”å¯¹è¡¨æ ¼
    function createAnswerComparison() {
        let comparisonHtml = `
            <div class="answer-comparison">
                <div class="comparison-title">ğŸ“Š ç­”æ¡ˆæ¯”å¯¹</div>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>é¢˜ç›®</th>
                            <th>æ‚¨çš„ç­”æ¡ˆ</th>
                            <th>æ­£ç¡®ç­”æ¡ˆ</th>
                            <th>ç»“æœ</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        for (let i = 0; i < Math.max(userAnswers.length, correctAnswers.length); i++) {
            const userAnswer = userAnswers[i] || '';
            const correctAnswer = correctAnswers[i] || '';
            const isCorrect = compareAnswers(userAnswer, correctAnswer);
            
            // è·å–é¢˜ç›®ç±»å‹æè¿°
            let questionType = `ç¬¬${i + 1}é¢˜`;
            if (i < userAnswers.length) {
                const inputElement = document.getElementById(`input-${i}`);
                if (inputElement) {
                    const dataType = inputElement.getAttribute('data-type');
                    if (dataType === 'b') {
                        questionType += ' (å•é€‰)';
                    } else if (dataType === 'a') {
                        questionType += ' (å¤šé€‰)';
                    } else if (dataType === 'number') {
                        questionType += ' (æ•°å­—)';
                    } else if (dataType === 'text') {
                        questionType += ' (æ–‡æœ¬)';
                    }
                }
            }

            const userAnswerClass = isCorrect ? 'correct-answer' : 'wrong-answer';
            const statusClass = isCorrect ? 'status-correct' : 'status-wrong';
            const statusText = isCorrect ? 'âœ“ æ­£ç¡®' : 'âœ— é”™è¯¯';

            comparisonHtml += `
                <tr>
                    <td>${questionType}</td>
                    <td class="${userAnswerClass}">${userAnswer || '(æœªä½œç­”)'}</td>
                    <td class="correct-answer">${correctAnswer}</td>
                    <td class="${statusClass}">${statusText}</td>
                </tr>
            `;
        }

        comparisonHtml += `
                    </tbody>
                </table>
            </div>
        `;

        return comparisonHtml;
    }

    // æ˜¾ç¤ºè§£æ
    function showAnalysis() {
        const backContent = document.getElementById('back-content');
        if (!backContent) return;

        let contentHtml = '';

        // å¦‚æœæœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºç­”æ¡ˆæ¯”å¯¹
        if (hasErrors) {
            contentHtml += createAnswerComparison();
            
            // æ˜¾ç¤ºè§£æå†…å®¹
            const analyzeContent = `{{Analyze}}`.trim();
            if (analyzeContent) {
                contentHtml += `
                    <div class="analysis-section">
                        <div class="analysis-title">ğŸ“– ç­”æ¡ˆè§£æ</div>
                        ${analyzeContent}
                    </div>
                `;
            }
        } else {
            // æ‰€æœ‰ç­”æ¡ˆéƒ½æ­£ç¡®ï¼Œæ˜¾ç¤ºæˆåŠŸä¿¡æ¯
            contentHtml += `
                <div class="success-message">
                    <span class="success-icon">ğŸ‰</span>
                    å›ç­”æ­£ç¡®ï¼æ­å–œä½ å…¨éƒ¨ç­”å¯¹äº†ï¼
                    <span class="success-icon">âœ¨</span>
                </div>
            `;
        }

        backContent.innerHTML = contentHtml;
    }

    // åˆå§‹åŒ–èƒŒé¢
    function initializeBack() {
        try {
            Persistence.setItem("SelectInResult",result);
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.select-blank') && !e.target.closest('.dropdown-menu')) {

                }
            });
            // é‡ç½®å…¨å±€å˜é‡
            hasErrors = false;
            userAnswers = [];
            correctAnswers = [];

            // è·å–ç”¨æˆ·ç­”æ¡ˆ
            const savedResults = Persistence.isAvailable() ? Persistence.getItem('SelectInResult') : null;
            addDebugText('åŸå§‹æŒä¹…åŒ–æ•°æ®: ' + JSON.stringify(savedResults));

            if (savedResults) {
                userAnswers = parseUserAnswers(savedResults);
                addDebugText('è§£æåçš„ç”¨æˆ·ç­”æ¡ˆ: ' + JSON.stringify(userAnswers));
            }

            // è·å–æ­£ç¡®ç­”æ¡ˆï¼ˆHTMLæ ¼å¼ï¼‰
            const answerHtml = `{{Answer}}`.trim();
            addDebugText('åŸå§‹ç­”æ¡ˆHTML: ' + answerHtml);

            correctAnswers = parseCorrectAnswers(answerHtml);
            addDebugText('è§£æåçš„æ­£ç¡®ç­”æ¡ˆ: ' + JSON.stringify(correctAnswers));

            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿å‰ç«¯çš„è¾“å…¥æ¡†å·²ç»åˆ›å»ºå®Œæˆ
            setTimeout(setInputBoxesReadOnly, 500);

        } catch (error) {
            addDebugText('åˆå§‹åŒ–èƒŒé¢æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            console.error('initializeBack error:', error);
        }
    }

    // æ›´æ–°è°ƒè¯•ä¿¡æ¯
    function updateDebugInfo(debugMessage) {
        // const debugOutput = document.getElementById('debug-output');
        // const currentTime = new Date().toLocaleTimeString();
        //
        // let displayText;
        // if (debugMessage) {
        //     // å¦‚æœæœ‰è‡ªå®šä¹‰è°ƒè¯•ä¿¡æ¯ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰ä¿¡æ¯
        //     displayText = `[${currentTime}] ${debugMessage}`;
        // }
        //
        // // æ·»åŠ æ–°çš„è°ƒè¯•ä¿¡æ¯åˆ°è¾“å‡ºåŒºåŸŸ
        // if (debugOutput.textContent.trim() === '') {
        //     debugOutput.textContent = displayText;
        // } else {
        //     debugOutput.textContent += '\n' + displayText;
        // }
        //
        // // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        // debugOutput.scrollTop = debugOutput.scrollHeight;
    }

    // æ·»åŠ è‡ªå®šä¹‰è°ƒè¯•æ–‡æœ¬
    function addDebugText(text) {
        updateDebugInfo(text);
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeBack);
    } else {
        initializeBack();
    }
</script>
