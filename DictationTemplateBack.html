<style>
    body {
        font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
    }

    .dictation-back-container {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        margin: 0 auto;
        position: relative;
        overflow: hidden;
    }

    .dictation-back-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .answer-reveal {
        text-align: center;
        margin-bottom: 30px;
        padding: 25px;
        background: linear-gradient(135deg, #f8faff, #f0f4ff);
        border-radius: 15px;
        border: 2px solid #e0e6ff;
    }

    .answer-title {
        font-size: 18px;
        color: #666;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .correct-word {
        font-size: 32px;
        font-weight: bold;
        color: #333;
        margin: 15px 0;
        letter-spacing: 1px;
        word-break: break-word;
    }

    .pronunciation-section {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .pronunciation-item {
        background: white;
        padding: 12px 18px;
        border-radius: 25px;
        border: 2px solid #e0e6ff;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .pronunciation-item:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .pronunciation-text {
        font-family: 'Doulos SIL', 'Charis SIL', 'DejaVu Sans', 'Lucida Grande', 'Segoe UI', Arial, sans-serif;
        font-size: 16px;
        color: #555;
        font-weight: normal;
        letter-spacing: 0.5px;
    }

    .definition-section {
        margin: 30px 0;
        padding: 25px;
        background: #f8fff8;
        border-radius: 15px;
        border-left: 5px solid #4CAF50;
    }

    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .definition-content {
        font-size: 16px;
        line-height: 1.8;
        color: #444;
    }

    .definition-item {
        margin: 10px 0;
        padding-left: 20px;
        position: relative;
    }

    .definition-item::before {
        content: 'â€¢';
        position: absolute;
        left: 0;
        color: #4CAF50;
        font-weight: bold;
        font-size: 18px;
    }


    .audio-replay-section {
        text-align: center;
        margin: 30px 0;
        padding: 20px;
        background: #f0f8ff;
        border-radius: 15px;
        border: 2px dashed #b3d9ff;
    }

    .replay-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .replay-button {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .uk-replay {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .us-replay {
        background: linear-gradient(135deg, #f093fb, #f5576c);
        color: white;
    }

    .replay-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    .user-input-section {
        margin: 30px 0;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 15px;
        border: 2px solid #ddd;
    }

    .input-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 15px;
    }

    .input-item {
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }

    .user-input {
        background: #fff0f0;
        border: 2px solid #ffcdd2;
    }

    .correct-input {
        background: #f0fff0;
        border: 2px solid #c8e6c8;
    }

    .input-label {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .input-text {
        font-size: 18px;
        font-weight: bold;
        word-break: break-word;
    }

    .result-indicator {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
    }

    .result-correct {
        background: #e8f5e8;
        color: #2e7d32;
        border: 2px solid #4CAF50;
    }

    .result-incorrect {
        background: #ffebee;
        color: #c62828;
        border: 2px solid #f44336;
    }

    .hidden-audio {
        display: none;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .dictation-back-container {
            padding: 20px;
            margin: 10px;
        }
        
        .correct-word {
            font-size: 24px;
        }
        
        .pronunciation-section {
            flex-direction: column;
            align-items: center;
        }
        
        .input-comparison {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .replay-controls {
            flex-direction: column;
            align-items: center;
        }
    }

    @media (max-width: 480px) {
        .correct-word {
            font-size: 20px;
        }
        
        .section-title {
            font-size: 18px;
        }
        
        .definition-content,
        .example-text {
            font-size: 14px;
        }
    }
</style>

<div class="dictation-back-container">
    <!-- ç­”æ¡ˆå±•ç¤ºåŒºåŸŸ -->
    <div class="answer-reveal">
        <div class="answer-title">
            ğŸ“ æ­£ç¡®ç­”æ¡ˆ
        </div>
        <div class="correct-word" id="correct-word">{{Front}}</div>
        
        <div class="pronunciation-section">
            <div class="pronunciation-item" onclick="playPronunciation('uk')">
                ğŸ‡¬ğŸ‡§ <span class="pronunciation-text" id="uk-phonetic">[è‹±å¼éŸ³æ ‡]</span>
            </div>
            <div class="pronunciation-item" onclick="playPronunciation('us')">
                ğŸ‡ºğŸ‡¸ <span class="pronunciation-text" id="us-phonetic">[ç¾å¼éŸ³æ ‡]</span>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·è¾“å…¥ä¸æ­£ç¡®ç­”æ¡ˆå¯¹æ¯” -->
    <div class="user-input-section" id="input-comparison-section" style="display: none;">
        <div class="section-title">
            ğŸ” ç­”æ¡ˆå¯¹æ¯”
        </div>
        <div class="input-comparison">
            <div class="input-item user-input">
                <div class="input-label">æ‚¨çš„ç­”æ¡ˆ</div>
                <div class="input-text" id="user-answer">-</div>
            </div>
            <div class="input-item correct-input">
                <div class="input-label">æ­£ç¡®ç­”æ¡ˆ</div>
                <div class="input-text" id="correct-answer">{{Front}}</div>
            </div>
        </div>
        <div class="result-indicator" id="result-indicator"></div>
    </div>

    <!-- å•è¯é‡Šä¹‰åŒºåŸŸ -->
    <div class="definition-section" id="definition-section">
        <div class="section-title">
            ğŸ“š è¯æ±‡é‡Šä¹‰
        </div>
        <div class="definition-content" id="definition-content">
            {{Definition}}
        </div>
    </div>


    <!-- éšè—çš„éŸ³é¢‘å…ƒç´  -->
    <audio id="uk-audio" class="hidden-audio" preload="auto"></audio>
    <audio id="us-audio" class="hidden-audio" preload="auto"></audio>
</div>

<script>
    // HTMLè§£ç å’Œæ¸…ç†å‡½æ•°
    function cleanHtmlText(text) {
        if (!text) return '';
        
        return text
            .replace(/&nbsp;/g, ' ')    // å°†&nbsp;è½¬æ¢ä¸ºæ™®é€šç©ºæ ¼
            .replace(/&amp;/g, '&')     // å¤„ç†&ç¬¦å·
            .replace(/&lt;/g, '<')      // å¤„ç†<ç¬¦å·
            .replace(/&gt;/g, '>')      // å¤„ç†>ç¬¦å·
            .replace(/&quot;/g, '"')    // å¤„ç†å¼•å·
            .replace(/&#39;/g, "'")     // å¤„ç†å•å¼•å·
            .replace(/&apos;/g, "'")    // å¤„ç†å•å¼•å·(å¦ä¸€ç§æ ¼å¼)
            .trim()                     // å»é™¤é¦–å°¾ç©ºæ ¼
            .replace(/\s+/g, ' ');      // å°†å¤šä¸ªç©ºæ ¼åˆå¹¶ä¸ºå•ä¸ªç©ºæ ¼
    }
    
    // è·å–å•è¯å’Œå…¶ä»–å­—æ®µå†…å®¹ï¼Œå¤„ç†å¤šä½™ç©ºæ ¼å’ŒHTMLå®ä½“
    const frontWord = cleanHtmlText(`{{Front}}`);
    const definitionContent = `{{Definition}}`.trim();
    
    // åˆå§‹åŒ–éŸ³é¢‘
    function initializeAudio() {
        const ukAudio = document.getElementById('uk-audio');
        const usAudio = document.getElementById('us-audio');
        
        if (frontWord && frontWord.trim() !== '') {
            console.log(`èƒŒé¢åˆå§‹åŒ–éŸ³é¢‘ï¼Œå•è¯: "${frontWord}"`);
            
            const ukUrl = getAudioUrl(frontWord, 'uk');
            const usUrl = getAudioUrl(frontWord, 'us');
            
            if (ukUrl) {
                ukAudio.src = ukUrl;
            } else {
                console.error('èƒŒé¢æ— æ³•ç”Ÿæˆè‹±å¼å‘éŸ³URL');
            }
            
            if (usUrl) {
                usAudio.src = usUrl;
            } else {
                console.error('èƒŒé¢æ— æ³•ç”Ÿæˆç¾å¼å‘éŸ³URL');
            }
        } else {
            console.warn('èƒŒé¢Frontå­—æ®µä¸ºç©ºæˆ–æ— æ•ˆï¼Œæ— æ³•åˆå§‹åŒ–éŸ³é¢‘');
        }
        
        // è®¾ç½®éŸ³é¢‘äº‹ä»¶ç›‘å¬å™¨
        [ukAudio, usAudio].forEach(audio => {
            audio.addEventListener('error', (e) => {
                console.error('éŸ³é¢‘åŠ è½½é”™è¯¯:', e);
            });
        });
    }
    
    // è·å–éŸ³é¢‘URLï¼ˆä¸æ­£é¢æ¨¡æ¿ç›¸åŒçš„é€»è¾‘ï¼‰
    function getAudioUrl(word, accent) {
        // éªŒè¯è¾“å…¥
        if (!word || word.trim() === '') {
            console.error('è·å–éŸ³é¢‘URLå¤±è´¥: å•è¯ä¸ºç©º');
            return '';
        }
        
        // æ¸…ç†å•è¯ï¼Œç¡®ä¿æ²¡æœ‰å¤šä½™ç©ºæ ¼å’ŒHTMLå®ä½“
        const cleanWord = cleanHtmlText(word);
        console.log(`èƒŒé¢è·å–éŸ³é¢‘URL: åŸå§‹å•è¯="${word}", æ¸…ç†å="${cleanWord}", å‘éŸ³="${accent}"`);
        
        try {
            const encodedWord = encodeURIComponent(cleanWord);
            if (accent === 'uk') {
                const url = `https://dict.youdao.com/dictvoice?audio=${encodedWord}&type=1`;
                console.log(`èƒŒé¢ç”Ÿæˆè‹±å¼å‘éŸ³URL: ${url}`);
                return url;
            } else {
                const url = `https://dict.youdao.com/dictvoice?audio=${encodedWord}&type=2`;
                console.log(`èƒŒé¢ç”Ÿæˆç¾å¼å‘éŸ³URL: ${url}`);
                return url;
            }
        } catch (error) {
            console.error('èƒŒé¢ç”ŸæˆéŸ³é¢‘URLæ—¶å‘ç”Ÿé”™è¯¯:', error);
            return '';
        }
    }
    
    // æ’­æ”¾å‘éŸ³
    function playPronunciation(accent) {
        const audioId = accent === 'uk' ? 'uk-audio' : 'us-audio';
        const audio = document.getElementById(audioId);
        
        // åœæ­¢å…¶ä»–éŸ³é¢‘
        const otherAudio = document.getElementById(accent === 'uk' ? 'us-audio' : 'uk-audio');
        if (!otherAudio.paused) {
            otherAudio.pause();
            otherAudio.currentTime = 0;
        }
        
        // æ’­æ”¾é€‰å®šçš„éŸ³é¢‘
        audio.currentTime = 0;
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error('æ’­æ”¾å¤±è´¥:', error);
            });
        }
    }
    
    // å¤„ç†Definitionå­—æ®µå†…å®¹
    function processDefinitionContent() {
        const definitionElement = document.getElementById('definition-content');
        const definitionSection = document.getElementById('definition-section');
        
        if (!definitionContent) {
            definitionSection.style.display = 'none';
            return;
        }
        
        // å¦‚æœDefinitionå­—æ®µåŒ…å«HTMLï¼Œç›´æ¥æ˜¾ç¤º
        // å¦‚æœæ˜¯çº¯æ–‡æœ¬ï¼Œè¿›è¡Œç®€å•çš„æ ¼å¼åŒ–
        if (definitionContent.includes('<')) {
            definitionElement.innerHTML = definitionContent;
        } else {
            // å°†æ¯è¡Œæ–‡æœ¬è½¬æ¢ä¸ºå®šä¹‰é¡¹
            const lines = definitionContent.split('\n').filter(line => line.trim());
            const formattedContent = lines.map(line => 
                `<div class="definition-item">${line.trim()}</div>`
            ).join('');
            definitionElement.innerHTML = formattedContent;
        }
    }
    
    
    // è·å–ç”¨æˆ·è¾“å…¥å¹¶è¿›è¡Œå¯¹æ¯”
    function getUserInputFromFront() {
        // è¿™é‡Œéœ€è¦è·å–æ­£é¢æ¨¡æ¿ä¸­ç”¨æˆ·çš„è¾“å…¥
        // ç”±äºAnkiçš„é™åˆ¶ï¼Œæˆ‘ä»¬é€šè¿‡localStorageæˆ–å…¶ä»–æ–¹å¼ä¼ é€’ç”¨æˆ·è¾“å…¥
        const userInput = localStorage.getItem('dictation_user_input') || '';
        
        if (userInput) {
            const inputSection = document.getElementById('input-comparison-section');
            const userAnswerElement = document.getElementById('user-answer');
            const resultIndicator = document.getElementById('result-indicator');
            
            inputSection.style.display = 'block';
            userAnswerElement.textContent = userInput;
            
            // æ¯”è¾ƒç­”æ¡ˆ
            const isCorrect = compareAnswers(userInput, frontWord);
            
            if (isCorrect) {
                resultIndicator.textContent = 'ğŸ‰ å›ç­”æ­£ç¡®ï¼';
                resultIndicator.className = 'result-indicator result-correct';
            } else {
                resultIndicator.textContent = 'âŒ å›ç­”é”™è¯¯ï¼Œè¯·ä»”ç»†å¯¹æ¯”';
                resultIndicator.className = 'result-indicator result-incorrect';
            }
        }
    }
    
    // æ¯”è¾ƒç­”æ¡ˆ
    function compareAnswers(userAnswer, correctAnswer) {
        if (!userAnswer || !correctAnswer) return false;
        
        // æ ‡å‡†åŒ–æ¯”è¾ƒï¼šè½¬æ¢ä¸ºå°å†™ï¼Œå»é™¤å¤šä½™ç©ºæ ¼å’Œæ ‡ç‚¹
        const normalize = (text) => {
            return text.toLowerCase()
                      .trim()
                      .replace(/[^\w\s]/g, '')
                      .replace(/\s+/g, ' ');
        };
        
        return normalize(userAnswer) === normalize(correctAnswer);
    }
    
    // å¤„ç†éŸ³æ ‡å†…å®¹
    function processPhoneticContent() {
        // ç›´æ¥ä»åœ¨çº¿APIè·å–éŸ³æ ‡
        fetchPhoneticFromAPI(frontWord);
    }
    
    
    // ä»åœ¨çº¿APIè·å–éŸ³æ ‡
    async function fetchPhoneticFromAPI(word) {
        const ukPhoneticElement = document.getElementById('uk-phonetic');
        const usPhoneticElement = document.getElementById('us-phonetic');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        ukPhoneticElement.textContent = '[åŠ è½½ä¸­...]';
        usPhoneticElement.textContent = '[åŠ è½½ä¸­...]';
        
        // å°è¯•å¤šä¸ªAPIæº
        const apiSources = [
            {
                name: 'Free Dictionary API',
                url: `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`,
                parser: parseFreeDictionaryAPI
            },
            {
                name: 'Cambridge Dictionary API (å¤‡ç”¨)',
                url: `https://dictionary.cambridge.org/search/english/direct/?q=${encodeURIComponent(word)}`,
                parser: parseCambridgeAPI,
                isHtml: true
            },
            {
                name: 'Oxford Learner Dictionary (å¤‡ç”¨)',
                url: `https://www.oxfordlearnersdictionaries.com/search/english/direct/?q=${encodeURIComponent(word)}`,
                parser: parseOxfordAPI,
                isHtml: true
            },
            {
                name: 'Wordnik API (å¤‡ç”¨)',
                url: `https://api.wordnik.com/v4/word.json/${encodeURIComponent(word)}/pronunciations?useCanonical=false&limit=50&api_key=demo`,
                parser: parseWordnikAPI
            }
        ];
        
        for (const source of apiSources) {
            try {
                console.log(`å°è¯•ä» ${source.name} è·å–éŸ³æ ‡...`);
                const response = await fetch(source.url);
                
                if (response.ok) {
                    let data;
                    if (source.isHtml) {
                        data = await response.text();
                    } else {
                        data = await response.json();
                    }
                    
                    const phonetics = source.parser(data);
                    
                    if (phonetics.uk || phonetics.us) {
                        const ukPhonetic = simplifyPhonetic(phonetics.uk || phonetics.us || '[è‹±å¼éŸ³æ ‡]');
                        const usPhonetic = simplifyPhonetic(phonetics.us || phonetics.uk || '[ç¾å¼éŸ³æ ‡]');
                        ukPhoneticElement.textContent = ukPhonetic;
                        usPhoneticElement.textContent = usPhonetic;
                        console.log(`ä» ${source.name} æˆåŠŸè·å–éŸ³æ ‡`);
                        return; // æˆåŠŸè·å–ï¼Œé€€å‡ºå¾ªç¯
                    }
                }
            } catch (error) {
                console.warn(`ä» ${source.name} è·å–éŸ³æ ‡å¤±è´¥:`, error);
            }
        }
        
        // æ‰€æœ‰APIéƒ½å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
        await tryAlternativePhoneticSources(word);
    }
    
    // è§£æFree Dictionary APIå“åº”
    function parseFreeDictionaryAPI(data) {
        const result = { uk: '', us: '' };
        
        if (data && Array.isArray(data) && data.length > 0) {
            const entry = data[0];
            const phonetics = entry.phonetics || [];
            
            // æŸ¥æ‰¾è‹±å¼éŸ³æ ‡
            const ukPhoneticObj = phonetics.find(p => 
                p.text && (
                    p.audio?.includes('-uk') || 
                    p.audio?.includes('_gb') || 
                    p.audio?.includes('uk.mp3')
                )
            );
            if (ukPhoneticObj) {
                result.uk = ukPhoneticObj.text;
            }
            
            // æŸ¥æ‰¾ç¾å¼éŸ³æ ‡
            const usPhoneticObj = phonetics.find(p => 
                p.text && (
                    p.audio?.includes('-us') || 
                    p.audio?.includes('_us') || 
                    p.audio?.includes('us.mp3')
                )
            );
            if (usPhoneticObj) {
                result.us = usPhoneticObj.text;
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šçš„éŸ³æ ‡ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„
            if (!result.uk && !result.us && phonetics.length > 0) {
                const firstPhonetic = phonetics.find(p => p.text);
                if (firstPhonetic) {
                    result.uk = result.us = firstPhonetic.text;
                }
            }
        }
        
        return result;
    }
    
    // è§£æMerriam-Webster APIå“åº”
    function parseMerriamWebsterAPI(data) {
        const result = { uk: '', us: '' };
        
        if (data && Array.isArray(data) && data.length > 0) {
            const entry = data[0];
            if (entry.hwi && entry.hwi.prs && entry.hwi.prs.length > 0) {
                const pronunciations = entry.hwi.prs;
                
                // æŸ¥æ‰¾éŸ³æ ‡
                for (const pron of pronunciations) {
                    if (pron.mw) {
                        // Merriam-Websteræ ¼å¼è½¬æ¢ä¸ºIPA
                        const ipaPhonetic = convertMWToIPA(pron.mw);
                        if (!result.us) {
                            result.us = ipaPhonetic;
                        }
                        if (!result.uk) {
                            result.uk = ipaPhonetic;
                        }
                    }
                }
            }
        }
        
        return result;
    }
    
    // è½¬æ¢Merriam-WebsteréŸ³æ ‡æ ¼å¼ä¸ºIPA
    function convertMWToIPA(mwPhonetic) {
        // ç®€å•çš„è½¬æ¢æ˜ å°„ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•
        const conversionMap = {
            'Ëˆ': 'Ëˆ',
            'ËŒ': 'ËŒ',
            'É™': 'É™',
            'Éª': 'Éª',
            'i': 'iË',
            'ÊŠ': 'ÊŠ',
            'u': 'uË',
            'e': 'e',
            'É›': 'É›',
            'Ã¦': 'Ã¦',
            'É‘': 'É‘Ë',
            'É”': 'É”Ë',
            'o': 'oÊŠ'
        };
        
        let result = mwPhonetic;
        for (const [mw, ipa] of Object.entries(conversionMap)) {
            result = result.replace(new RegExp(mw, 'g'), ipa);
        }
        
        return `/${result}/`;
    }
    
    // è§£æCambridge Dictionaryå“åº”
    function parseCambridgeAPI(htmlText) {
        const result = { uk: '', us: '' };
        
        try {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶DOMæ¥è§£æHTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            
            // æŸ¥æ‰¾éŸ³æ ‡å…ƒç´ 
            const phoneticElements = doc.querySelectorAll('.ipa, .pron-info .ipa, .us .ipa, .uk .ipa');
            
            for (const element of phoneticElements) {
                const phoneticText = element.textContent.trim();
                const parentElement = element.closest('.us, .uk, .pron-info');
                
                if (parentElement) {
                    if (parentElement.classList.contains('uk') || parentElement.textContent.includes('UK')) {
                        result.uk = phoneticText;
                    } else if (parentElement.classList.contains('us') || parentElement.textContent.includes('US')) {
                        result.us = phoneticText;
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰ç‰¹å®šæ ‡è¯†ï¼Œä½œä¸ºé€šç”¨éŸ³æ ‡
                    if (!result.uk) result.uk = phoneticText;
                    if (!result.us) result.us = phoneticText;
                }
            }
        } catch (error) {
            console.error('è§£æCambridge Dictionaryå“åº”å¤±è´¥:', error);
        }
        
        return result;
    }
    
    // è§£æOxford Learner Dictionaryå“åº”
    function parseOxfordAPI(htmlText) {
        const result = { uk: '', us: '' };
        
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            
            // æŸ¥æ‰¾éŸ³æ ‡å…ƒç´ 
            const phoneticElements = doc.querySelectorAll('.phon, .pron-g .phon');
            
            for (const element of phoneticElements) {
                const phoneticText = element.textContent.trim();
                const geoElement = element.closest('[data-geo]') || element.querySelector('[data-geo]');
                
                if (geoElement) {
                    const geo = geoElement.getAttribute('data-geo');
                    if (geo === 'br' || geo === 'uk') {
                        result.uk = phoneticText;
                    } else if (geo === 'am' || geo === 'us') {
                        result.us = phoneticText;
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰åœ°ç†æ ‡è¯†ï¼Œä½œä¸ºé€šç”¨éŸ³æ ‡
                    if (!result.uk) result.uk = phoneticText;
                    if (!result.us) result.us = phoneticText;
                }
            }
        } catch (error) {
            console.error('è§£æOxford Dictionaryå“åº”å¤±è´¥:', error);
        }
        
        return result;
    }
    
    // è§£æWordnik APIå“åº”
    function parseWordnikAPI(data) {
        const result = { uk: '', us: '' };
        
        try {
            if (data && Array.isArray(data)) {
                for (const pronunciation of data) {
                    if (pronunciation.rawType) {
                        const phoneticText = pronunciation.rawType;
                        // Wordniké€šå¸¸ä¸åŒºåˆ†è‹±å¼å’Œç¾å¼ï¼Œä½¿ç”¨é€šç”¨éŸ³æ ‡
                        if (!result.uk) result.uk = phoneticText;
                        if (!result.us) result.us = phoneticText;
                        break;
                    }
                }
            }
        } catch (error) {
            console.error('è§£æWordnik APIå“åº”å¤±è´¥:', error);
        }
        
        return result;
    }
    
    // å°è¯•å…¶ä»–éŸ³æ ‡æ¥æº
    async function tryAlternativePhoneticSources(word) {
        const ukPhoneticElement = document.getElementById('uk-phonetic');
        const usPhoneticElement = document.getElementById('us-phonetic');
        
        // æ–¹æ³•1: å°è¯•ä½¿ç”¨Wiktionary API
        try {
            console.log('å°è¯•ä»Wiktionaryè·å–éŸ³æ ‡...');
            const wiktionaryUrl = `https://en.wiktionary.org/api/rest_v1/page/definition/${encodeURIComponent(word)}`;
            const response = await fetch(wiktionaryUrl);
            
            if (response.ok) {
                const data = await response.json();
                const phonetics = parseWiktionaryResponse(data);
                
                if (phonetics.uk || phonetics.us) {
                    ukPhoneticElement.textContent = phonetics.uk || phonetics.us || '[è‹±å¼éŸ³æ ‡]';
                    usPhoneticElement.textContent = phonetics.us || phonetics.uk || '[ç¾å¼éŸ³æ ‡]';
                    console.log('ä»WiktionaryæˆåŠŸè·å–éŸ³æ ‡');
                    return;
                }
            }
        } catch (error) {
            console.warn('ä»Wiktionaryè·å–éŸ³æ ‡å¤±è´¥:', error);
        }
        
        // æ–¹æ³•2: å°è¯•ä½¿ç”¨WordsAPI
        try {
            console.log('å°è¯•ä»WordsAPIè·å–éŸ³æ ‡...');
            const wordsApiUrl = `https://wordsapiv1.p.rapidapi.com/words/${encodeURIComponent(word)}/pronunciation`;
            const response = await fetch(wordsApiUrl, {
                headers: {
                    'X-RapidAPI-Key': 'YOUR_RAPIDAPI_KEY', // éœ€è¦æ›¿æ¢ä¸ºå®é™…çš„APIå¯†é’¥
                    'X-RapidAPI-Host': 'wordsapiv1.p.rapidapi.com'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.pronunciation) {
                    const phonetic = data.pronunciation.all || data.pronunciation;
                    ukPhoneticElement.textContent = phonetic;
                    usPhoneticElement.textContent = phonetic;
                    console.log('ä»WordsAPIæˆåŠŸè·å–éŸ³æ ‡');
                    return;
                }
            }
        } catch (error) {
            console.warn('ä»WordsAPIè·å–éŸ³æ ‡å¤±è´¥:', error);
        }
        
        // æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥
        console.log('æ‰€æœ‰éŸ³æ ‡è·å–æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ˜¾ç¤º');
        setDefaultPhonetics();
    }
    
    // è§£æWiktionaryå“åº”
    function parseWiktionaryResponse(data) {
        const result = { uk: '', us: '' };
        
        try {
            if (data && data.en && Array.isArray(data.en)) {
                for (const entry of data.en) {
                    if (entry.definitions && Array.isArray(entry.definitions)) {
                        for (const def of entry.definitions) {
                            const text = def.definition || '';
                            // æŸ¥æ‰¾IPAéŸ³æ ‡æ¨¡å¼
                            const ipaMatch = text.match(/\/([^\/]+)\//);
                            if (ipaMatch) {
                                const phonetic = `/${ipaMatch[1]}/`;
                                if (!result.uk) result.uk = phonetic;
                                if (!result.us) result.us = phonetic;
                                break;
                            }
                        }
                    }
                }
            }
        } catch (error) {
            console.error('è§£æWiktionaryå“åº”å¤±è´¥:', error);
        }
        
        return result;
    }
    
    // è½¬æ¢ä¸ºè‹±å¼éŸ³æ ‡ç¬¦å·
    function simplifyPhonetic(phoneticText) {
        // è‹±å¼éŸ³æ ‡ç¬¦å·è½¬æ¢æ˜ å°„
        const britishPhoneticMap = {
            // åŸºæœ¬å…ƒéŸ³
            'É¹': 'r',         // å€’r -> æ™®é€šr
            'Ã¦': 'Ã¦',         // ä¿æŒÃ¦ç¬¦å·ï¼ˆè‹±å¼å¸¸ç”¨ï¼‰
            'É‘Ë': 'É‘:',       // é•¿aéŸ³
            'É’': 'É”',         // çŸ­oéŸ³
            'É”Ë': 'É”:',       // é•¿oéŸ³
            'ÊŒ': 'ÊŒ',         // ä¿æŒæ¥”å½¢ç¬¦å·
            'ÉœË': 'Éœ:',       // é•¿eéŸ³
            'É™': 'É™',         // ä¿æŒä¸­æ€§å…ƒéŸ³
            'Éª': 'Éª',         // ä¿æŒçŸ­i
            'iË': 'i:',       // é•¿iéŸ³
            'ÊŠ': 'ÊŠ',         // ä¿æŒçŸ­u
            'uË': 'u:',       // é•¿uéŸ³
            'eÉª': 'eÉª',       // åŒå…ƒéŸ³ei
            'aÉª': 'aÉª',       // åŒå…ƒéŸ³ai
            'É”Éª': 'É”Éª',       // åŒå…ƒéŸ³oi
            'aÊŠ': 'aÊŠ',       // åŒå…ƒéŸ³au
            'É™ÊŠ': 'É™ÊŠ',       // åŒå…ƒéŸ³ouï¼ˆè‹±å¼ï¼‰
            'ÉªÉ™': 'ÉªÉ™',       // åŒå…ƒéŸ³ia
            'eÉ™': 'eÉ™',       // åŒå…ƒéŸ³ea
            'ÊŠÉ™': 'ÊŠÉ™',       // åŒå…ƒéŸ³ua
            
            // è¾…éŸ³
            'Î¸': 'Î¸',         // ä¿æŒtheta
            'Ã°': 'Ã°',         // ä¿æŒeth
            'Êƒ': 'Êƒ',         // ä¿æŒesh
            'Ê’': 'Ê’',         // ä¿æŒezh
            'Ê§': 'tÊƒ',        // chéŸ³
            'Ê¤': 'dÊ’',        // jéŸ³
            'Å‹': 'Å‹',         // ä¿æŒeng
            'j': 'j',         // yéŸ³
            'w': 'w',         // wéŸ³
            
            // é‡éŸ³å’Œé•¿éŸ³ç¬¦å·
            'Ë': ':',         // é•¿éŸ³ç¬¦å·
            'Ëˆ': "'",         // ä¸»é‡éŸ³
            'ËŒ': ',',         // æ¬¡é‡éŸ³
            
            // ç¾å¼ç‰¹æœ‰éŸ³ç´ è½¬æ¢ä¸ºè‹±å¼
            'Éš': 'É™',         // ç¾å¼råŒ–å…ƒéŸ³ -> ä¸­æ€§å…ƒéŸ³
            'É': 'Éœ:',        // ç¾å¼råŒ–å…ƒéŸ³ -> è‹±å¼é•¿eéŸ³
            'É‘r': 'É‘:',       // ç¾å¼ar -> è‹±å¼é•¿a
            'É”r': 'É”:',       // ç¾å¼or -> è‹±å¼é•¿o
            'É›r': 'eÉ™',       // ç¾å¼er -> è‹±å¼eaåŒå…ƒéŸ³
            'Éªr': 'ÉªÉ™',       // ç¾å¼ir -> è‹±å¼iaåŒå…ƒéŸ³
            'ÊŠr': 'ÊŠÉ™',       // ç¾å¼ur -> è‹±å¼uaåŒå…ƒéŸ³
        };
        
        let result = phoneticText;
        
        // æŒ‰ç…§é•¿åˆ°çŸ­çš„é¡ºåºæ›¿æ¢ï¼Œé¿å…éƒ¨åˆ†åŒ¹é…é—®é¢˜
        const sortedKeys = Object.keys(britishPhoneticMap).sort((a, b) => b.length - a.length);
        
        for (const ipaSymbol of sortedKeys) {
            const britishSymbol = britishPhoneticMap[ipaSymbol];
            // ä½¿ç”¨å…¨å±€æ›¿æ¢
            result = result.replace(new RegExp(ipaSymbol.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), britishSymbol);
        }
        
        return result;
    }
    
    // è®¾ç½®é»˜è®¤éŸ³æ ‡æ˜¾ç¤º
    function setDefaultPhonetics() {
        document.getElementById('uk-phonetic').textContent = '[ç‚¹å‡»æ’­æ”¾è‹±å¼å‘éŸ³]';
        document.getElementById('us-phonetic').textContent = '[ç‚¹å‡»æ’­æ”¾ç¾å¼å‘éŸ³]';
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializeAudio();
        processDefinitionContent();
        processPhoneticContent();
        getUserInputFromFront();
        
        // æ¸…é™¤localStorageä¸­çš„ç”¨æˆ·è¾“å…¥ï¼ˆé¿å…å½±å“ä¸‹ä¸€å¼ å¡ç‰‡ï¼‰
        setTimeout(() => {
            localStorage.removeItem('dictation_user_input');
        }, 1000);
    });
    
    // å¯¼å‡ºå‡½æ•°ä¾›å¤–éƒ¨è°ƒç”¨
    window.dictationBackUtils = {
        playPronunciation: playPronunciation,
        compareAnswers: compareAnswers
    };
</script>
