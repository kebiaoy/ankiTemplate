<style>
    body {
        font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
    }

    .dictation-back-container {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        margin: 0 auto;
        position: relative;
        overflow: hidden;
    }

    .dictation-back-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .answer-reveal {
        text-align: center;
        margin-bottom: 30px;
        padding: 25px;
        background: linear-gradient(135deg, #f8faff, #f0f4ff);
        border-radius: 15px;
        border: 2px solid #e0e6ff;
    }

    .answer-title {
        font-size: 18px;
        color: #666;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .correct-word {
        font-size: 32px;
        font-weight: bold;
        color: #333;
        margin: 15px 0;
        letter-spacing: 1px;
        word-break: break-word;
    }

    .pronunciation-section {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .pronunciation-item {
        background: white;
        padding: 12px 18px;
        border-radius: 25px;
        border: 2px solid #e0e6ff;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .pronunciation-item:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .pronunciation-text {
        font-family: 'Doulos SIL', 'Charis SIL', 'DejaVu Sans', 'Lucida Grande', 'Segoe UI', Arial, sans-serif;
        font-size: 16px;
        color: #555;
        font-weight: normal;
        letter-spacing: 0.5px;
    }

    .definition-section {
        margin: 30px 0;
        padding: 25px;
        background: #f8fff8;
        border-radius: 15px;
        border-left: 5px solid #4CAF50;
    }

    .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .definition-content {
        font-size: 16px;
        line-height: 1.8;
        color: #444;
    }

    .definition-item {
        margin: 10px 0;
        padding-left: 20px;
        position: relative;
    }

    .definition-item::before {
        content: '•';
        position: absolute;
        left: 0;
        color: #4CAF50;
        font-weight: bold;
        font-size: 18px;
    }


    .audio-replay-section {
        text-align: center;
        margin: 30px 0;
        padding: 20px;
        background: #f0f8ff;
        border-radius: 15px;
        border: 2px dashed #b3d9ff;
    }

    .replay-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .replay-button {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .uk-replay {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .us-replay {
        background: linear-gradient(135deg, #f093fb, #f5576c);
        color: white;
    }

    .replay-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    .user-input-section {
        margin: 30px 0;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 15px;
        border: 2px solid #ddd;
    }

    .input-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 15px;
    }

    .input-item {
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }

    .user-input {
        background: #fff0f0;
        border: 2px solid #ffcdd2;
    }

    .correct-input {
        background: #f0fff0;
        border: 2px solid #c8e6c8;
    }

    .input-label {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .input-text {
        font-size: 18px;
        font-weight: bold;
        word-break: break-word;
    }

    .result-indicator {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
    }

    .result-correct {
        background: #e8f5e8;
        color: #2e7d32;
        border: 2px solid #4CAF50;
    }

    .result-incorrect {
        background: #ffebee;
        color: #c62828;
        border: 2px solid #f44336;
    }

    .hidden-audio {
        display: none;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .dictation-back-container {
            padding: 20px;
            margin: 10px;
        }
        
        .correct-word {
            font-size: 24px;
        }
        
        .pronunciation-section {
            flex-direction: column;
            align-items: center;
        }
        
        .input-comparison {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .replay-controls {
            flex-direction: column;
            align-items: center;
        }
    }

    @media (max-width: 480px) {
        .correct-word {
            font-size: 20px;
        }
        
        .section-title {
            font-size: 18px;
        }
        
        .definition-content,
        .example-text {
            font-size: 14px;
        }
    }
</style>

<div class="dictation-back-container">
    <!-- 答案展示区域 -->
    <div class="answer-reveal">
        <div class="answer-title">
            📝 正确答案
        </div>
        <div class="correct-word" id="correct-word">{{Front}}</div>
        
        <div class="pronunciation-section">
            <div class="pronunciation-item" onclick="playPronunciation('uk')">
                🇬🇧 <span class="pronunciation-text" id="uk-phonetic">[英式音标]</span>
            </div>
            <div class="pronunciation-item" onclick="playPronunciation('us')">
                🇺🇸 <span class="pronunciation-text" id="us-phonetic">[美式音标]</span>
            </div>
        </div>
    </div>

    <!-- 用户输入与正确答案对比 -->
    <div class="user-input-section" id="input-comparison-section" style="display: none;">
        <div class="section-title">
            🔍 答案对比
        </div>
        <div class="input-comparison">
            <div class="input-item user-input">
                <div class="input-label">您的答案</div>
                <div class="input-text" id="user-answer">-</div>
            </div>
            <div class="input-item correct-input">
                <div class="input-label">正确答案</div>
                <div class="input-text" id="correct-answer">{{Front}}</div>
            </div>
        </div>
        <div class="result-indicator" id="result-indicator"></div>
    </div>

    <!-- 单词释义区域 -->
    <div class="definition-section" id="definition-section">
        <div class="section-title">
            📚 词汇释义
        </div>
        <div class="definition-content" id="definition-content">
            {{Definition}}
        </div>
    </div>


    <!-- 隐藏的音频元素 -->
    <audio id="uk-audio" class="hidden-audio" preload="auto"></audio>
    <audio id="us-audio" class="hidden-audio" preload="auto"></audio>
</div>

<script>
    // HTML解码和清理函数
    function cleanHtmlText(text) {
        if (!text) return '';
        
        return text
            .replace(/&nbsp;/g, ' ')    // 将&nbsp;转换为普通空格
            .replace(/&amp;/g, '&')     // 处理&符号
            .replace(/&lt;/g, '<')      // 处理<符号
            .replace(/&gt;/g, '>')      // 处理>符号
            .replace(/&quot;/g, '"')    // 处理引号
            .replace(/&#39;/g, "'")     // 处理单引号
            .replace(/&apos;/g, "'")    // 处理单引号(另一种格式)
            .trim()                     // 去除首尾空格
            .replace(/\s+/g, ' ');      // 将多个空格合并为单个空格
    }
    
    // 获取单词和其他字段内容，处理多余空格和HTML实体
    const frontWord = cleanHtmlText(`{{Front}}`);
    const definitionContent = `{{Definition}}`.trim();
    
    // 初始化音频
    function initializeAudio() {
        const ukAudio = document.getElementById('uk-audio');
        const usAudio = document.getElementById('us-audio');
        
        if (frontWord && frontWord.trim() !== '') {
            console.log(`背面初始化音频，单词: "${frontWord}"`);
            
            const ukUrl = getAudioUrl(frontWord, 'uk');
            const usUrl = getAudioUrl(frontWord, 'us');
            
            if (ukUrl) {
                ukAudio.src = ukUrl;
            } else {
                console.error('背面无法生成英式发音URL');
            }
            
            if (usUrl) {
                usAudio.src = usUrl;
            } else {
                console.error('背面无法生成美式发音URL');
            }
        } else {
            console.warn('背面Front字段为空或无效，无法初始化音频');
        }
        
        // 设置音频事件监听器
        [ukAudio, usAudio].forEach(audio => {
            audio.addEventListener('error', (e) => {
                console.error('音频加载错误:', e);
            });
        });
    }
    
    // 获取音频URL（与正面模板相同的逻辑）
    function getAudioUrl(word, accent) {
        // 验证输入
        if (!word || word.trim() === '') {
            console.error('获取音频URL失败: 单词为空');
            return '';
        }
        
        // 清理单词，确保没有多余空格和HTML实体
        const cleanWord = cleanHtmlText(word);
        console.log(`背面获取音频URL: 原始单词="${word}", 清理后="${cleanWord}", 发音="${accent}"`);
        
        try {
            const encodedWord = encodeURIComponent(cleanWord);
            if (accent === 'uk') {
                const url = `https://dict.youdao.com/dictvoice?audio=${encodedWord}&type=1`;
                console.log(`背面生成英式发音URL: ${url}`);
                return url;
            } else {
                const url = `https://dict.youdao.com/dictvoice?audio=${encodedWord}&type=2`;
                console.log(`背面生成美式发音URL: ${url}`);
                return url;
            }
        } catch (error) {
            console.error('背面生成音频URL时发生错误:', error);
            return '';
        }
    }
    
    // 播放发音
    function playPronunciation(accent) {
        const audioId = accent === 'uk' ? 'uk-audio' : 'us-audio';
        const audio = document.getElementById(audioId);
        
        // 停止其他音频
        const otherAudio = document.getElementById(accent === 'uk' ? 'us-audio' : 'uk-audio');
        if (!otherAudio.paused) {
            otherAudio.pause();
            otherAudio.currentTime = 0;
        }
        
        // 播放选定的音频
        audio.currentTime = 0;
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error('播放失败:', error);
            });
        }
    }
    
    // 处理Definition字段内容
    function processDefinitionContent() {
        const definitionElement = document.getElementById('definition-content');
        const definitionSection = document.getElementById('definition-section');
        
        if (!definitionContent) {
            definitionSection.style.display = 'none';
            return;
        }
        
        // 如果Definition字段包含HTML，直接显示
        // 如果是纯文本，进行简单的格式化
        if (definitionContent.includes('<')) {
            definitionElement.innerHTML = definitionContent;
        } else {
            // 将每行文本转换为定义项
            const lines = definitionContent.split('\n').filter(line => line.trim());
            const formattedContent = lines.map(line => 
                `<div class="definition-item">${line.trim()}</div>`
            ).join('');
            definitionElement.innerHTML = formattedContent;
        }
    }
    
    
    // 获取用户输入并进行对比
    function getUserInputFromFront() {
        // 这里需要获取正面模板中用户的输入
        // 由于Anki的限制，我们通过localStorage或其他方式传递用户输入
        const userInput = localStorage.getItem('dictation_user_input') || '';
        
        if (userInput) {
            const inputSection = document.getElementById('input-comparison-section');
            const userAnswerElement = document.getElementById('user-answer');
            const resultIndicator = document.getElementById('result-indicator');
            
            inputSection.style.display = 'block';
            userAnswerElement.textContent = userInput;
            
            // 比较答案
            const isCorrect = compareAnswers(userInput, frontWord);
            
            if (isCorrect) {
                resultIndicator.textContent = '🎉 回答正确！';
                resultIndicator.className = 'result-indicator result-correct';
            } else {
                resultIndicator.textContent = '❌ 回答错误，请仔细对比';
                resultIndicator.className = 'result-indicator result-incorrect';
            }
        }
    }
    
    // 比较答案
    function compareAnswers(userAnswer, correctAnswer) {
        if (!userAnswer || !correctAnswer) return false;
        
        // 标准化比较：转换为小写，去除多余空格和标点
        const normalize = (text) => {
            return text.toLowerCase()
                      .trim()
                      .replace(/[^\w\s]/g, '')
                      .replace(/\s+/g, ' ');
        };
        
        return normalize(userAnswer) === normalize(correctAnswer);
    }
    
    // 处理音标内容
    function processPhoneticContent() {
        // 直接从在线API获取音标
        fetchPhoneticFromAPI(frontWord);
    }
    
    
    // 从在线API获取音标
    async function fetchPhoneticFromAPI(word) {
        const ukPhoneticElement = document.getElementById('uk-phonetic');
        const usPhoneticElement = document.getElementById('us-phonetic');
        
        // 显示加载状态
        ukPhoneticElement.textContent = '[加载中...]';
        usPhoneticElement.textContent = '[加载中...]';
        
        // 尝试多个API源
        const apiSources = [
            {
                name: 'Free Dictionary API',
                url: `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`,
                parser: parseFreeDictionaryAPI
            },
            {
                name: 'Cambridge Dictionary API (备用)',
                url: `https://dictionary.cambridge.org/search/english/direct/?q=${encodeURIComponent(word)}`,
                parser: parseCambridgeAPI,
                isHtml: true
            },
            {
                name: 'Oxford Learner Dictionary (备用)',
                url: `https://www.oxfordlearnersdictionaries.com/search/english/direct/?q=${encodeURIComponent(word)}`,
                parser: parseOxfordAPI,
                isHtml: true
            },
            {
                name: 'Wordnik API (备用)',
                url: `https://api.wordnik.com/v4/word.json/${encodeURIComponent(word)}/pronunciations?useCanonical=false&limit=50&api_key=demo`,
                parser: parseWordnikAPI
            }
        ];
        
        for (const source of apiSources) {
            try {
                console.log(`尝试从 ${source.name} 获取音标...`);
                const response = await fetch(source.url);
                
                if (response.ok) {
                    let data;
                    if (source.isHtml) {
                        data = await response.text();
                    } else {
                        data = await response.json();
                    }
                    
                    const phonetics = source.parser(data);
                    
                    if (phonetics.uk || phonetics.us) {
                        const ukPhonetic = simplifyPhonetic(phonetics.uk || phonetics.us || '[英式音标]');
                        const usPhonetic = simplifyPhonetic(phonetics.us || phonetics.uk || '[美式音标]');
                        ukPhoneticElement.textContent = ukPhonetic;
                        usPhoneticElement.textContent = usPhonetic;
                        console.log(`从 ${source.name} 成功获取音标`);
                        return; // 成功获取，退出循环
                    }
                }
            } catch (error) {
                console.warn(`从 ${source.name} 获取音标失败:`, error);
            }
        }
        
        // 所有API都失败，尝试其他方法
        await tryAlternativePhoneticSources(word);
    }
    
    // 解析Free Dictionary API响应
    function parseFreeDictionaryAPI(data) {
        const result = { uk: '', us: '' };
        
        if (data && Array.isArray(data) && data.length > 0) {
            const entry = data[0];
            const phonetics = entry.phonetics || [];
            
            // 查找英式音标
            const ukPhoneticObj = phonetics.find(p => 
                p.text && (
                    p.audio?.includes('-uk') || 
                    p.audio?.includes('_gb') || 
                    p.audio?.includes('uk.mp3')
                )
            );
            if (ukPhoneticObj) {
                result.uk = ukPhoneticObj.text;
            }
            
            // 查找美式音标
            const usPhoneticObj = phonetics.find(p => 
                p.text && (
                    p.audio?.includes('-us') || 
                    p.audio?.includes('_us') || 
                    p.audio?.includes('us.mp3')
                )
            );
            if (usPhoneticObj) {
                result.us = usPhoneticObj.text;
            }
            
            // 如果没有找到特定的音标，使用第一个可用的
            if (!result.uk && !result.us && phonetics.length > 0) {
                const firstPhonetic = phonetics.find(p => p.text);
                if (firstPhonetic) {
                    result.uk = result.us = firstPhonetic.text;
                }
            }
        }
        
        return result;
    }
    
    // 解析Merriam-Webster API响应
    function parseMerriamWebsterAPI(data) {
        const result = { uk: '', us: '' };
        
        if (data && Array.isArray(data) && data.length > 0) {
            const entry = data[0];
            if (entry.hwi && entry.hwi.prs && entry.hwi.prs.length > 0) {
                const pronunciations = entry.hwi.prs;
                
                // 查找音标
                for (const pron of pronunciations) {
                    if (pron.mw) {
                        // Merriam-Webster格式转换为IPA
                        const ipaPhonetic = convertMWToIPA(pron.mw);
                        if (!result.us) {
                            result.us = ipaPhonetic;
                        }
                        if (!result.uk) {
                            result.uk = ipaPhonetic;
                        }
                    }
                }
            }
        }
        
        return result;
    }
    
    // 转换Merriam-Webster音标格式为IPA
    function convertMWToIPA(mwPhonetic) {
        // 简单的转换映射，可以根据需要扩展
        const conversionMap = {
            'ˈ': 'ˈ',
            'ˌ': 'ˌ',
            'ə': 'ə',
            'ɪ': 'ɪ',
            'i': 'iː',
            'ʊ': 'ʊ',
            'u': 'uː',
            'e': 'e',
            'ɛ': 'ɛ',
            'æ': 'æ',
            'ɑ': 'ɑː',
            'ɔ': 'ɔː',
            'o': 'oʊ'
        };
        
        let result = mwPhonetic;
        for (const [mw, ipa] of Object.entries(conversionMap)) {
            result = result.replace(new RegExp(mw, 'g'), ipa);
        }
        
        return `/${result}/`;
    }
    
    // 解析Cambridge Dictionary响应
    function parseCambridgeAPI(htmlText) {
        const result = { uk: '', us: '' };
        
        try {
            // 创建一个临时DOM来解析HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            
            // 查找音标元素
            const phoneticElements = doc.querySelectorAll('.ipa, .pron-info .ipa, .us .ipa, .uk .ipa');
            
            for (const element of phoneticElements) {
                const phoneticText = element.textContent.trim();
                const parentElement = element.closest('.us, .uk, .pron-info');
                
                if (parentElement) {
                    if (parentElement.classList.contains('uk') || parentElement.textContent.includes('UK')) {
                        result.uk = phoneticText;
                    } else if (parentElement.classList.contains('us') || parentElement.textContent.includes('US')) {
                        result.us = phoneticText;
                    }
                } else {
                    // 如果没有特定标识，作为通用音标
                    if (!result.uk) result.uk = phoneticText;
                    if (!result.us) result.us = phoneticText;
                }
            }
        } catch (error) {
            console.error('解析Cambridge Dictionary响应失败:', error);
        }
        
        return result;
    }
    
    // 解析Oxford Learner Dictionary响应
    function parseOxfordAPI(htmlText) {
        const result = { uk: '', us: '' };
        
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            
            // 查找音标元素
            const phoneticElements = doc.querySelectorAll('.phon, .pron-g .phon');
            
            for (const element of phoneticElements) {
                const phoneticText = element.textContent.trim();
                const geoElement = element.closest('[data-geo]') || element.querySelector('[data-geo]');
                
                if (geoElement) {
                    const geo = geoElement.getAttribute('data-geo');
                    if (geo === 'br' || geo === 'uk') {
                        result.uk = phoneticText;
                    } else if (geo === 'am' || geo === 'us') {
                        result.us = phoneticText;
                    }
                } else {
                    // 如果没有地理标识，作为通用音标
                    if (!result.uk) result.uk = phoneticText;
                    if (!result.us) result.us = phoneticText;
                }
            }
        } catch (error) {
            console.error('解析Oxford Dictionary响应失败:', error);
        }
        
        return result;
    }
    
    // 解析Wordnik API响应
    function parseWordnikAPI(data) {
        const result = { uk: '', us: '' };
        
        try {
            if (data && Array.isArray(data)) {
                for (const pronunciation of data) {
                    if (pronunciation.rawType) {
                        const phoneticText = pronunciation.rawType;
                        // Wordnik通常不区分英式和美式，使用通用音标
                        if (!result.uk) result.uk = phoneticText;
                        if (!result.us) result.us = phoneticText;
                        break;
                    }
                }
            }
        } catch (error) {
            console.error('解析Wordnik API响应失败:', error);
        }
        
        return result;
    }
    
    // 尝试其他音标来源
    async function tryAlternativePhoneticSources(word) {
        const ukPhoneticElement = document.getElementById('uk-phonetic');
        const usPhoneticElement = document.getElementById('us-phonetic');
        
        // 方法1: 尝试使用Wiktionary API
        try {
            console.log('尝试从Wiktionary获取音标...');
            const wiktionaryUrl = `https://en.wiktionary.org/api/rest_v1/page/definition/${encodeURIComponent(word)}`;
            const response = await fetch(wiktionaryUrl);
            
            if (response.ok) {
                const data = await response.json();
                const phonetics = parseWiktionaryResponse(data);
                
                if (phonetics.uk || phonetics.us) {
                    ukPhoneticElement.textContent = phonetics.uk || phonetics.us || '[英式音标]';
                    usPhoneticElement.textContent = phonetics.us || phonetics.uk || '[美式音标]';
                    console.log('从Wiktionary成功获取音标');
                    return;
                }
            }
        } catch (error) {
            console.warn('从Wiktionary获取音标失败:', error);
        }
        
        // 方法2: 尝试使用WordsAPI
        try {
            console.log('尝试从WordsAPI获取音标...');
            const wordsApiUrl = `https://wordsapiv1.p.rapidapi.com/words/${encodeURIComponent(word)}/pronunciation`;
            const response = await fetch(wordsApiUrl, {
                headers: {
                    'X-RapidAPI-Key': 'YOUR_RAPIDAPI_KEY', // 需要替换为实际的API密钥
                    'X-RapidAPI-Host': 'wordsapiv1.p.rapidapi.com'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.pronunciation) {
                    const phonetic = data.pronunciation.all || data.pronunciation;
                    ukPhoneticElement.textContent = phonetic;
                    usPhoneticElement.textContent = phonetic;
                    console.log('从WordsAPI成功获取音标');
                    return;
                }
            }
        } catch (error) {
            console.warn('从WordsAPI获取音标失败:', error);
        }
        
        // 所有方法都失败
        console.log('所有音标获取方法都失败，使用默认显示');
        setDefaultPhonetics();
    }
    
    // 解析Wiktionary响应
    function parseWiktionaryResponse(data) {
        const result = { uk: '', us: '' };
        
        try {
            if (data && data.en && Array.isArray(data.en)) {
                for (const entry of data.en) {
                    if (entry.definitions && Array.isArray(entry.definitions)) {
                        for (const def of entry.definitions) {
                            const text = def.definition || '';
                            // 查找IPA音标模式
                            const ipaMatch = text.match(/\/([^\/]+)\//);
                            if (ipaMatch) {
                                const phonetic = `/${ipaMatch[1]}/`;
                                if (!result.uk) result.uk = phonetic;
                                if (!result.us) result.us = phonetic;
                                break;
                            }
                        }
                    }
                }
            }
        } catch (error) {
            console.error('解析Wiktionary响应失败:', error);
        }
        
        return result;
    }
    
    // 转换为英式音标符号
    function simplifyPhonetic(phoneticText) {
        // 英式音标符号转换映射
        const britishPhoneticMap = {
            // 基本元音
            'ɹ': 'r',         // 倒r -> 普通r
            'æ': 'æ',         // 保持æ符号（英式常用）
            'ɑː': 'ɑ:',       // 长a音
            'ɒ': 'ɔ',         // 短o音
            'ɔː': 'ɔ:',       // 长o音
            'ʌ': 'ʌ',         // 保持楔形符号
            'ɜː': 'ɜ:',       // 长e音
            'ə': 'ə',         // 保持中性元音
            'ɪ': 'ɪ',         // 保持短i
            'iː': 'i:',       // 长i音
            'ʊ': 'ʊ',         // 保持短u
            'uː': 'u:',       // 长u音
            'eɪ': 'eɪ',       // 双元音ei
            'aɪ': 'aɪ',       // 双元音ai
            'ɔɪ': 'ɔɪ',       // 双元音oi
            'aʊ': 'aʊ',       // 双元音au
            'əʊ': 'əʊ',       // 双元音ou（英式）
            'ɪə': 'ɪə',       // 双元音ia
            'eə': 'eə',       // 双元音ea
            'ʊə': 'ʊə',       // 双元音ua
            
            // 辅音
            'θ': 'θ',         // 保持theta
            'ð': 'ð',         // 保持eth
            'ʃ': 'ʃ',         // 保持esh
            'ʒ': 'ʒ',         // 保持ezh
            'ʧ': 'tʃ',        // ch音
            'ʤ': 'dʒ',        // j音
            'ŋ': 'ŋ',         // 保持eng
            'j': 'j',         // y音
            'w': 'w',         // w音
            
            // 重音和长音符号
            'ː': ':',         // 长音符号
            'ˈ': "'",         // 主重音
            'ˌ': ',',         // 次重音
            
            // 美式特有音素转换为英式
            'ɚ': 'ə',         // 美式r化元音 -> 中性元音
            'ɝ': 'ɜ:',        // 美式r化元音 -> 英式长e音
            'ɑr': 'ɑ:',       // 美式ar -> 英式长a
            'ɔr': 'ɔ:',       // 美式or -> 英式长o
            'ɛr': 'eə',       // 美式er -> 英式ea双元音
            'ɪr': 'ɪə',       // 美式ir -> 英式ia双元音
            'ʊr': 'ʊə',       // 美式ur -> 英式ua双元音
        };
        
        let result = phoneticText;
        
        // 按照长到短的顺序替换，避免部分匹配问题
        const sortedKeys = Object.keys(britishPhoneticMap).sort((a, b) => b.length - a.length);
        
        for (const ipaSymbol of sortedKeys) {
            const britishSymbol = britishPhoneticMap[ipaSymbol];
            // 使用全局替换
            result = result.replace(new RegExp(ipaSymbol.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), britishSymbol);
        }
        
        return result;
    }
    
    // 设置默认音标显示
    function setDefaultPhonetics() {
        document.getElementById('uk-phonetic').textContent = '[点击播放英式发音]';
        document.getElementById('us-phonetic').textContent = '[点击播放美式发音]';
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        initializeAudio();
        processDefinitionContent();
        processPhoneticContent();
        getUserInputFromFront();
        
        // 清除localStorage中的用户输入（避免影响下一张卡片）
        setTimeout(() => {
            localStorage.removeItem('dictation_user_input');
        }, 1000);
    });
    
    // 导出函数供外部调用
    window.dictationBackUtils = {
        playPronunciation: playPronunciation,
        compareAnswers: compareAnswers
    };
</script>
