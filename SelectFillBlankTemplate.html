<script>
    // v1.1.8 - https://github.com/SimonLammer/anki-persistence/blob/584396fea9dea0921011671a47a0fdda19265e62/script.js
    if(void 0===window.Persistence){var e="github.com/SimonLammer/anki-persistence/",t="_default";if(window.Persistence_sessionStorage=function(){var i=!1;try{"object"==typeof window.sessionStorage&&(i=!0,this.clear=function(){for(var t=0;t<sessionStorage.length;t++){var i=sessionStorage.key(t);0==i.indexOf(e)&&(sessionStorage.removeItem(i),t--)}},this.setItem=function(i,n){void 0==n&&(n=i,i=t),sessionStorage.setItem(e+i,JSON.stringify(n))},this.getItem=function(i){return void 0==i&&(i=t),JSON.parse(sessionStorage.getItem(e+i))},this.removeItem=function(i){void 0==i&&(i=t),sessionStorage.removeItem(e+i)},this.getAllKeys=function(){for(var t=[],i=Object.keys(sessionStorage),n=0;n<i.length;n++){var s=i[n];0==s.indexOf(e)&&t.push(s.substring(e.length,s.length))}return t.sort()})}catch(n){}this.isAvailable=function(){return i}},window.Persistence_windowKey=function(i){var n=window[i],s=!1;"object"==typeof n&&(s=!0,this.clear=function(){n[e]={}},this.setItem=function(i,s){void 0==s&&(s=i,i=t),n[e][i]=s},this.getItem=function(i){return void 0==i&&(i=t),void 0==n[e][i]?null:n[e][i]},this.removeItem=function(i){void 0==i&&(i=t),delete n[e][i]},this.getAllKeys=function(){return Object.keys(n[e])},void 0==n[e]&&this.clear()),this.isAvailable=function(){return s}},window.Persistence=new Persistence_sessionStorage,Persistence.isAvailable()||(window.Persistence=new Persistence_windowKey("py")),!Persistence.isAvailable()){var i=window.location.toString().indexOf("title"),n=window.location.toString().indexOf("main",i);i>0&&n>0&&n-i<10&&(window.Persistence=new Persistence_windowKey("qt"))}}
</script>

<style>
    .select-blank {
        display: inline-block;
        min-width: 50px;
        max-width: 120px;
        padding: 2px 6px;
        border: 2px solid #4A90E2;
        border-radius: 4px;
        background-color: #f8f9fa;
        cursor: pointer;
        text-align: center;
        position: relative;
        height: 24px;
        line-height: 20px;
        margin: 0 1px;
        font-size: 14px;
        vertical-align: middle;
    }
    
    .select-blank:hover {
        background-color: #e3f2fd;
    }
    
    .select-blank.selected {
        background-color: #bbdefb;
    }
    
    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: max-content;
        max-width: 300px;
        width: auto;
        display: none;
        padding: 5px 0;
        white-space: nowrap;
    }
    
    .dropdown-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        white-space: normal;
        word-wrap: break-word;
        min-width: fit-content;
    }
    
    .dropdown-item:hover {
        background-color: #f5f5f5;
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .dropdown-item input[type="checkbox"],
    .dropdown-item input[type="radio"] {
        margin-right: 8px;
    }
    
    .question-container {
        font-size: 16px;
        line-height: 1.6;
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fafafa;
    }
    
    .debug-info {
        margin-top: 20px;
        padding: 10px;
        background-color: #f0f0f0;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
    }
    
    .debug-input {
        width: 100%;
        padding: 5px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-family: monospace;
        font-size: 12px;
    }
    
    .debug-output {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 5px;
        background-color: white;
        white-space: pre-wrap;
    }
    
    .input-blank {
        display: inline-block;
        min-width: 60px;
        max-width: 150px;
        width: auto;
        padding: 2px 6px;
        border: none;
        border-bottom: 2px solid #4A90E2;
        border-radius: 0;
        background-color: transparent;
        font-size: 14px;
        height: 24px;
        line-height: 20px;
        margin: 0 1px;
        vertical-align: middle;
        box-sizing: border-box;
    }
    
    .input-blank:focus {
        outline: none;
        border-bottom-color: #2196F3;
        box-shadow: 0 2px 3px rgba(33, 150, 243, 0.3);
    }
    
    .number-input {
        text-align: center;
    }
</style>


<div id="question-display" class="question-container"></div>
<!--<div id="debug" class="debug-info">-->
<!--    <input type="text" id="debug-input" class="debug-input" placeholder="输入调试文本，按回车添加">-->
<!--    <div id="debug-output" class="debug-output"></div>-->
<!--</div>-->

<script>
    // 全局变量
    let SelectInResult = [];
    let questionData = [];
    let currentOpenDropdown = null;
    
    // HTML解码函数
    function decodeHtmlEntities(text) {
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    }
    
    // 解析输入数据
    function parseQuestionData(input) {
        // 保留原始HTML结构，只解析输入框标记
        let htmlContent = input;
        const inputFields = [];
        
        // 提取所有的转义输入框标记
        const inputMatches = [];
        const escapedInputRegex = /&lt;(s&amp;[ab][^&]*(?:&amp;[ab][^&]*)*|n|t)&gt;/g;
        let match;
        while ((match = escapedInputRegex.exec(input)) !== null) {
            // 解码这个特定的输入框标记
            const decodedMatch = decodeHtmlEntities(match[0]);
            inputMatches.push({
                original: match[0],     // 原始转义格式
                decoded: decodedMatch,  // 解码后格式
                content: match[1]       // 内容部分
            });
        }
        
        inputMatches.forEach((matchInfo, index) => {
            const content = decodeHtmlEntities(matchInfo.content);
            
            if (content.startsWith('s')) {
                // 选择框 s&b... 或 s&a...
                const selectContent = content.substring(1); // 去掉 's'
                const type = selectContent[1]; // 'a' 或 'b'
                
                // 提取选项
                const optionMatches = selectContent.match(/&[ab][^&]+/g) || [];
                const options = optionMatches.map(opt => opt.substring(2)).filter(opt => opt.trim() !== '');
                
                inputFields.push({
                    index: index,
                    type: 'select',
                    selectType: type,
                    options: options,
                    placeholder: '请选择'
                });
            } else if (content === 'n') {
                // 数字输入框
                inputFields.push({
                    index: index,
                    type: 'number',
                    placeholder: '输入数字'
                });
            } else if (content === 't') {
                // 文本输入框
                inputFields.push({
                    index: index,
                    type: 'text',
                    placeholder: '输入文本'
                });
            }
            
            // 在HTML内容中用占位符替换原始的转义标记
            htmlContent = htmlContent.replace(matchInfo.original, `__INPUT_${index}__`);
        });
        
        return { htmlContent, inputFields };
    }
    
    // 初始化SelectInResult
    function initializeSelectInResult(inputFields) {
        SelectInResult = []; // 清空
        
        inputFields.forEach((field, index) => {
            if (field.type === 'select') {
                SelectInResult.push({
                    index: index,
                    type: 'select',
                    selectType: field.selectType,
                    SelectValue: []
                });
            } else if (field.type === 'number') {
                SelectInResult.push({
                    index: index,
                    type: 'number',
                    value: ''
                });
            } else if (field.type === 'text') {
                SelectInResult.push({
                    index: index,
                    type: 'text',
                    value: ''
                });
            }
        });
        
        // 持久化存储初始状态
        if (Persistence.isAvailable()) {
            Persistence.setItem('SelectInResult', SelectInResult);
        }
        
        updateDebugInfo('SelectInResult已初始化，共' + SelectInResult.length + '个输入框');
    }
    
    // 创建输入框
    function createInputField(field) {
        const index = field.index;
        
        if (field.type === 'select') {
            const isMultiple = field.selectType === 'a';
            return `<span id="input-${index}" class="select-blank" data-index="${index}" data-type="${field.selectType}" data-multiple="${isMultiple}" onclick="showDropdown(${index}, this)">${getDisplayText(index)}</span>`;
        } else if (field.type === 'number') {
            return `<input id="input-${index}" type="text" class="input-blank number-input" data-index="${index}" data-type="number" placeholder="${field.placeholder}" oninput="handleNumberInput(${index}, this)" onblur="saveInputValue(${index}, this.value)">`;
        } else if (field.type === 'text') {
            return `<input id="input-${index}" type="text" class="input-blank" data-index="${index}" data-type="text" placeholder="${field.placeholder}" oninput="handleTextInput(${index}, this)" onblur="saveInputValue(${index}, this.value)">`;
        }
        
        return '';
    }
    
    // 获取显示文本（仅用于选择框）
    function getDisplayText(index) {
        if (index >= SelectInResult.length) return "请选择";
        
        const result = SelectInResult[index];
        if (result.type !== 'select' || result.SelectValue.length === 0) {
            return "请选择";
        }
        
        // SelectValue数组已经按照选项顺序排序，直接使用
        const selectedLabels = result.SelectValue.map(i => {
            return String.fromCharCode(65 + i); // A, B, C, D...
        }).filter(Boolean);
        
        return selectedLabels.length > 0 ? selectedLabels.join(', ') : "请选择";
    }
    
    // 处理数字输入
    function handleNumberInput(index, element) {
        const value = element.value;
        // 只允许数字和小数点
        const filteredValue = value.replace(/[^0-9.]/g, '');
        
        // 防止多个小数点
        const parts = filteredValue.split('.');
        if (parts.length > 2) {
            element.value = parts[0] + '.' + parts.slice(1).join('');
        } else {
            element.value = filteredValue;
        }
    }
    
    // 处理文本输入
    function handleTextInput(index, element) {
        // 文本输入不需要特殊处理，允许所有字符
    }
    
    // 保存输入值
    function saveInputValue(index, value) {
        if (index < SelectInResult.length) {
            SelectInResult[index].value = value;
            
            // 持久化存储
            if (Persistence.isAvailable()) {
                Persistence.setItem('SelectInResult', SelectInResult);
            }
            
            const inputType = SelectInResult[index].type;
            updateDebugInfo(`${inputType}输入框${index}输入了: ${value}`);
        }
    }
    
    // 显示下拉菜单
    function showDropdown(index, element) {
        // 关闭其他打开的下拉菜单
        closeAllDropdowns();
        
        const field = questionData.inputFields[index];
        if (!field || field.type !== 'select') return;
        
        const type = field.selectType;
        const isMultiple = type === 'a';
        const options = field.options || [];
        
        // 创建下拉菜单
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-menu';
        dropdown.style.display = 'block';
        
        options.forEach((option, optionIndex) => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            
            const inputType = isMultiple ? 'checkbox' : 'radio';
            const inputName = isMultiple ? `select_${index}` : `select_${index}`;
            const isChecked = SelectInResult[index] && SelectInResult[index].SelectValue.includes(optionIndex);
            
            const optionLabel = String.fromCharCode(65 + optionIndex); // A, B, C, D...
            item.innerHTML = `
                <input type="${inputType}" name="${inputName}" value="${optionIndex}" ${isChecked ? 'checked' : ''}>
                <span>${optionLabel}. ${option}</span>
            `;
            
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const input = item.querySelector('input');
                if (input.type === 'radio') {
                    // 单选：清除所有选择，只选中当前项
                    const allInputs = dropdown.querySelectorAll('input[type="radio"]');
                    allInputs.forEach(inp => inp.checked = false);
                    input.checked = true;
                    SelectInResult[index].SelectValue = [optionIndex];
                    closeAllDropdowns();
                } else {
                    // 多选：切换选择状态
                    input.checked = !input.checked;
                    if (input.checked) {
                        if (!SelectInResult[index].SelectValue.includes(optionIndex)) {
                            SelectInResult[index].SelectValue.push(optionIndex);
                            // 添加后按照选项顺序排序
                            SelectInResult[index].SelectValue.sort((a, b) => a - b);
                        }
                    } else {
                        SelectInResult[index].SelectValue = SelectInResult[index].SelectValue.filter(v => v !== optionIndex);
                        // 移除后数组自然保持排序状态
                    }
                }
                
                const selectedOption = options[optionIndex];
                const selectionType = isMultiple ? '多选' : '单选';
                updateDebugInfo(`${selectionType}框${index}选择了: ${selectedOption}`);
            });
            
            dropdown.appendChild(item);
        });
        
        element.appendChild(dropdown);
        
        // 动态调整下拉菜单宽度
        adjustDropdownWidth(dropdown, element);
        
        currentOpenDropdown = dropdown;
    }
    
    // 动态调整下拉菜单宽度
    function adjustDropdownWidth(dropdown, triggerElement) {
        // 临时显示下拉菜单以测量内容宽度
        dropdown.style.visibility = 'hidden';
        dropdown.style.display = 'block';
        dropdown.style.width = 'auto';
        dropdown.style.minWidth = 'max-content';
        
        // 获取所有菜单项的最大宽度
        const items = dropdown.querySelectorAll('.dropdown-item');
        let maxWidth = 0;
        
        items.forEach(item => {
            const itemWidth = item.scrollWidth;
            maxWidth = Math.max(maxWidth, itemWidth);
        });
        
        // 确保下拉菜单不会比触发元素小太多，但也不会过宽
        const triggerWidth = triggerElement.offsetWidth;
        const minMenuWidth = Math.max(triggerWidth, 80); // 最小宽度为触发元素宽度或80px
        const maxMenuWidth = Math.min(maxWidth + 20, 500); // 最大宽度限制为300px，加20px的缓冲
        
        const finalWidth = Math.max(minMenuWidth, Math.min(maxMenuWidth, maxWidth + 20));
        
        // 应用计算出的宽度
        dropdown.style.width = finalWidth + 'px';
        dropdown.style.minWidth = finalWidth + 'px';
        
        // 检查是否超出视口右边界，如果是则调整位置
        const rect = dropdown.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        
        if (rect.right > viewportWidth) {
            const overflowAmount = rect.right - viewportWidth + 10; // 10px缓冲
            dropdown.style.left = `-${overflowAmount}px`;
        }
        
        // 恢复显示
        dropdown.style.visibility = 'visible';
    }
    
    // 更新所有选择框的显示文本
    function updateAllSelectDisplays() {
        document.querySelectorAll('.select-blank').forEach((element, index) => {
            const dataIndex = parseInt(element.getAttribute('data-index'));
            if (!isNaN(dataIndex) && dataIndex < SelectInResult.length) {
                const result = SelectInResult[dataIndex];
                if (result.type === 'select') {
                    element.textContent = getDisplayText(dataIndex);
                }
            }
        });
    }

    // 关闭所有下拉菜单
    function closeAllDropdowns() {
        const dropdowns = document.querySelectorAll('.dropdown-menu');
        dropdowns.forEach(dropdown => {
            dropdown.style.display = 'none';
            dropdown.remove();
        });
        if(currentOpenDropdown == null){
            return;
        }
        currentOpenDropdown = null;
        
        // 菜单关闭后更新所有选择框的显示文本
        updateAllSelectDisplays();
        
        // 菜单关闭后进行持久化存储
        if (Persistence.isAvailable()) {
            Persistence.setItem('SelectInResult', SelectInResult);
            updateDebugInfo('菜单关闭，更新显示文本并保存状态');
        } else {
            updateDebugInfo('菜单关闭，更新显示文本（持久化存储不可用）');
        }
    }
    
    // 更新调试信息
    function updateDebugInfo(debugMessage) {
        // const debugOutput = document.getElementById('debug-output');
        // const currentTime = new Date().toLocaleTimeString();
        //
        // let displayText;
        // if (debugMessage) {
        //     // 如果有自定义调试信息，显示自定义信息
        //     displayText = `[${currentTime}] ${debugMessage}`;
        // } else {
        //     // 如果没有自定义信息，显示SelectInResult
        //     displayText = `[${currentTime}] SelectInResult: ${JSON.stringify(SelectInResult, null, 2)}`;
        // }
        //
        // // 添加新的调试信息到输出区域
        // if (debugOutput.textContent.trim() === '') {
        //     debugOutput.textContent = displayText;
        // } else {
        //     debugOutput.textContent += '\n' + displayText;
        // }
        //
        // // 自动滚动到底部
        // debugOutput.scrollTop = debugOutput.scrollHeight;
    }
    
    // 添加自定义调试文本
    function addDebugText(text) {
        //updateDebugInfo(text);
    }
    
    // 处理HTML内容
    function processHtmlContent(htmlContent, inputFields) {
        let processed = htmlContent;
        
        // 替换所有的 __INPUT_X__ 标记
        inputFields.forEach((field, index) => {
            const placeholder = `__INPUT_${index}__`;
            const inputElement = createInputField(field);
            processed = processed.replace(placeholder, inputElement);
        });
        
        return processed;
    }
    
    // 创建帮助手册
    function createHelpManual() {
        return `
            <div style="padding: 20px; border: 2px solid #4A90E2; border-radius: 8px; background-color: #f8f9fa; margin: 20px 0;">
                <h3 style="color: #4A90E2; margin-top: 0;">📖 选择填空题输入格式帮助</h3>
                
                <h4>🔤 基本格式：</h4>
                <p>在Anki的HTML字段中使用转义字符：<code>&amp;lt;...&amp;gt;</code> 包裹输入框</p>
                
                <h4>📝 输入框类型：</h4>
                <ul>
                    <li><strong>单选框：</strong><code>&amp;lt;s&amp;amp;b选项1&amp;amp;b选项2&amp;amp;b选项3&amp;amp;b&amp;gt;</code></li>
                    <li><strong>多选框：</strong><code>&amp;lt;s&amp;amp;a选项1&amp;amp;a选项2&amp;amp;a选项3&amp;amp;a&amp;gt;</code></li>
                    <li><strong>数字输入：</strong><code>&amp;lt;n&amp;gt;</code> （只能输入数字和小数点）</li>
                    <li><strong>文本输入：</strong><code>&amp;lt;t&amp;gt;</code> （可输入任何文本）</li>
                </ul>
                
                <h4>💡 示例（Anki字段中的格式）：</h4>
                <div style="background-color: #e3f2fd; padding: 10px; border-radius: 4px; font-family: monospace; word-break: break-all;">
                    &amp;lt;p&amp;gt;你吃&amp;lt;s&amp;amp;b饭&amp;amp;b鱼&amp;amp;b肉&amp;amp;b&amp;gt;吗?我想吃&amp;lt;s&amp;amp;a狗肉&amp;amp;a猪手&amp;amp;a肌肉&amp;amp;a&amp;gt;很好了.还想吃&amp;lt;n&amp;gt;这个，不想吃&amp;lt;t&amp;gt;那个&amp;lt;/p&amp;gt;
                </div>
                
                <h4>📋 格式说明：</h4>
                <ul>
                    <li><code>&amp;amp;b</code> 表示单选选项（radio）</li>
                    <li><code>&amp;amp;a</code> 表示多选选项（checkbox）</li>
                    <li><code>&amp;lt;</code> 和 <code>&amp;gt;</code> 是HTML转义的 &lt; 和 &gt;</li>
                    <li><code>&amp;amp;</code> 是HTML转义的 &amp;</li>
                    <li>选项会自动添加 A、B、C 标签</li>
                    <li>多选结果按 A、B、C 顺序显示和存储</li>
                </ul>
                
                <h4>🎯 使用方法：</h4>
                <p>在Anki卡片的 <strong>{{Front}}</strong> 字段中输入上述格式的文本即可</p>
                
                <hr style="margin: 15px 0;">
                <p style="color: #666; font-style: italic; margin-bottom: 0;">
                    💡 提示：下方显示的是示例效果，您可以尝试操作各种输入框
                </p>
            </div>
        `;
    }

    // 初始化
    function initialize() {
        // 从Anki字段获取数据
        const frontContent = `{{Front}}`.trim();
        
        let inputData;
        let showHelp = false;
        
        if (!frontContent) {
            // 如果Front字段为空，显示帮助手册和示例
            showHelp = true;
            inputData = '<p>你吃&lt;s&amp;b饭&amp;b鱼&amp;b肉&amp;b&gt;吗?我想吃&lt;s&amp;a狗肉&amp;a猪手&amp;a肌肉&amp;a&gt;很好了.还想吃&lt;n&gt;这个，不想吃&lt;t&gt;那个</p><figure class="image"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjEwMCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+示例图片</text></svg>" alt="示例图片"></figure>';
        } else {
            inputData = frontContent;
        }
        
        // 解析数据
        questionData = parseQuestionData(inputData);
        
        // 显示帮助手册（如果需要）
        let displayContent = '';
        if (showHelp) {
            displayContent += createHelpManual();
            displayContent += '<h4>📌 示例效果：</h4>';
        }
        
        // 处理HTML内容并显示
        const processedHtml = processHtmlContent(questionData.htmlContent, questionData.inputFields);
        displayContent += processedHtml;
        
        document.getElementById('question-display').innerHTML = displayContent;
        
        // 初始化SelectInResult
        initializeSelectInResult(questionData.inputFields);

        // 从持久化存储中恢复状态
        if (Persistence.isAvailable()) {
            const saved = Persistence.getItem('SelectInResult');
            if (saved) {
                SelectInResult = saved;
                // 更新显示
                restoreInputValues();
                updateDebugInfo('从存储中恢复了之前的输入状态');
            } else {
                updateDebugInfo('没有找到之前保存的状态，使用默认值');
            }
        } else {
            updateDebugInfo('持久化存储不可用');
        }
    }
    
    // 恢复输入值
    function restoreInputValues() {
        SelectInResult.forEach((result, index) => {
            if (result.type === 'select') {
                const element = document.querySelector(`.select-blank[data-index="${index}"]`);
                if (element) {
                    element.textContent = getDisplayText(index);
                }
            } else if (result.type === 'number' || result.type === 'text') {
                const element = document.querySelector(`.input-blank[data-index="${index}"]`);
                if (element && result.value) {
                    element.value = result.value;
                }
            }
        });
    }
    
    // 点击页面其他地方关闭下拉菜单
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.select-blank') && !e.target.closest('.dropdown-menu')) {
            closeAllDropdowns();
        }
    });
    
    // // 处理调试输入框的回车事件
    // document.addEventListener('DOMContentLoaded', () => {
    //     const debugInput = document.getElementById('debug-input');
    //     debugInput.addEventListener('keypress', (e) => {
    //         if (e.key === 'Enter') {
    //             const text = debugInput.value.trim();
    //             if (text) {
    //                 addDebugText(text);
    //                 debugInput.value = ''; // 清空输入框
    //             }
    //         }
    //     });
    // });
    
    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
</script>
