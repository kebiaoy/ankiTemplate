<script>
    // v1.1.8 - https://github.com/SimonLammer/anki-persistence/blob/584396fea9dea0921011671a47a0fdda19265e62/script.js
    if(void 0===window.Persistence){var e="github.com/SimonLammer/anki-persistence/",t="_default";if(window.Persistence_sessionStorage=function(){var i=!1;try{"object"==typeof window.sessionStorage&&(i=!0,this.clear=function(){for(var t=0;t<sessionStorage.length;t++){var i=sessionStorage.key(t);0==i.indexOf(e)&&(sessionStorage.removeItem(i),t--)}},this.setItem=function(i,n){void 0==n&&(n=i,i=t),sessionStorage.setItem(e+i,JSON.stringify(n))},this.getItem=function(i){return void 0==i&&(i=t),JSON.parse(sessionStorage.getItem(e+i))},this.removeItem=function(i){void 0==i&&(i=t),sessionStorage.removeItem(e+i)},this.getAllKeys=function(){for(var t=[],i=Object.keys(sessionStorage),n=0;n<i.length;n++){var s=i[n];0==s.indexOf(e)&&t.push(s.substring(e.length,s.length))}return t.sort()})}catch(n){}this.isAvailable=function(){return i}},window.Persistence_windowKey=function(i){var n=window[i],s=!1;"object"==typeof n&&(s=!0,this.clear=function(){n[e]={}},this.setItem=function(i,s){void 0==s&&(s=i,i=t),n[e][i]=s},this.getItem=function(i){return void 0==i&&(i=t),void 0==n[e][i]?null:n[e][i]},this.removeItem=function(i){void 0==i&&(i=t),delete n[e][i]},this.getAllKeys=function(){return Object.keys(n[e])},void 0==n[e]&&this.clear()),this.isAvailable=function(){return s}},window.Persistence=new Persistence_sessionStorage,Persistence.isAvailable()||(window.Persistence=new Persistence_windowKey("py")),!Persistence.isAvailable()){var i=window.location.toString().indexOf("title"),n=window.location.toString().indexOf("main",i);i>0&&n>0&&n-i<10&&(window.Persistence=new Persistence_windowKey("qt"))}}
</script>

<style>
    .select-blank {
        display: inline-block;
        min-width: 80px;
        padding: 4px 8px;
        border: 2px solid #4A90E2;
        border-radius: 4px;
        background-color: #f8f9fa;
        cursor: pointer;
        text-align: center;
        position: relative;
        min-height: 20px;
        margin: 0 2px;
    }
    
    .select-blank:hover {
        background-color: #e3f2fd;
    }
    
    .select-blank.selected {
        background-color: #bbdefb;
    }
    
    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 120px;
        display: none;
        padding: 5px 0;
    }
    
    .dropdown-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
    }
    
    .dropdown-item:hover {
        background-color: #f5f5f5;
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .dropdown-item input[type="checkbox"],
    .dropdown-item input[type="radio"] {
        margin-right: 8px;
    }
    
    .question-container {
        font-size: 16px;
        line-height: 1.6;
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fafafa;
    }
    
    .debug-info {
        margin-top: 20px;
        padding: 10px;
        background-color: #f0f0f0;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
    }
    
    .debug-input {
        width: 100%;
        padding: 5px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-family: monospace;
        font-size: 12px;
    }
    
    .debug-output {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 5px;
        background-color: white;
        white-space: pre-wrap;
    }
    
    .input-blank {
        display: inline-block;
        min-width: 80px;
        padding: 4px 8px;
        border: 2px solid #4A90E2;
        border-radius: 4px;
        background-color: white;
        font-size: 14px;
        margin: 0 2px;
    }
    
    .input-blank:focus {
        outline: none;
        border-color: #2196F3;
        box-shadow: 0 0 3px rgba(33, 150, 243, 0.3);
    }
    
    .number-input {
        text-align: center;
    }
</style>

{{Front}}

<div id="question-display" class="question-container"></div>
<div id="debug" class="debug-info">
    <input type="text" id="debug-input" class="debug-input" placeholder="输入调试文本，按回车添加">
    <div id="debug-output" class="debug-output"></div>
</div>

<script>
    // 全局变量
    let SelectInResult = [];
    let questionData = [];
    let currentOpenDropdown = null;
    
    // 解析输入数据
    function parseQuestionData(input) {
        let question = input;
        const inputFields = [];
        
        // 匹配所有的输入框 <...>
        const inputMatches = input.match(/<[^>]+>/g) || [];
        
        inputMatches.forEach((match, index) => {
            const content = match.slice(1, -1); // 去掉 < 和 >
            
            if (content.startsWith('s')) {
                // 选择框 <s&b...> 或 <s&a...>
                const selectContent = content.substring(1); // 去掉 's'
                const type = selectContent[1]; // 'a' 或 'b'
                
                // 提取选项
                const optionMatches = selectContent.match(/&[ab][^&]+/g) || [];
                const options = optionMatches.map(opt => opt.substring(2)).filter(opt => opt.trim() !== ''); // 去掉 &a 或 &b 并过滤空选项
                
                inputFields.push({
                    index: index,
                    type: 'select',
                    selectType: type, // 'a' 多选, 'b' 单选
                    options: options,
                    placeholder: '请选择'
                });
            } else if (content === 'n') {
                // 数字输入框
                inputFields.push({
                    index: index,
                    type: 'number',
                    placeholder: '输入数字'
                });
            } else if (content === 't') {
                // 文本输入框
                inputFields.push({
                    index: index,
                    type: 'text',
                    placeholder: '输入文本'
                });
            }
            
            // 替换问题中的输入框标记
            question = question.replace(match, `__INPUT_${index}__`);
        });
        
        return { question, inputFields };
    }
    
    // 初始化SelectInResult
    function initializeSelectInResult(inputFields) {
        SelectInResult = []; // 清空
        
        inputFields.forEach((field, index) => {
            if (field.type === 'select') {
                SelectInResult.push({
                    index: index,
                    type: 'select',
                    selectType: field.selectType,
                    SelectValue: []
                });
            } else if (field.type === 'number') {
                SelectInResult.push({
                    index: index,
                    type: 'number',
                    value: ''
                });
            } else if (field.type === 'text') {
                SelectInResult.push({
                    index: index,
                    type: 'text',
                    value: ''
                });
            }
        });
        
        // 持久化存储初始状态
        if (Persistence.isAvailable()) {
            Persistence.setItem('SelectInResult', SelectInResult);
        }
        
        updateDebugInfo('SelectInResult已初始化，共' + SelectInResult.length + '个输入框');
    }
    
    // 创建输入框
    function createInputField(field) {
        const index = field.index;
        
        if (field.type === 'select') {
            const isMultiple = field.selectType === 'a';
            return `<span class="select-blank" data-index="${index}" data-type="${field.selectType}" data-multiple="${isMultiple}" onclick="showDropdown(${index}, this)">${getDisplayText(index)}</span>`;
        } else if (field.type === 'number') {
            return `<input type="text" class="input-blank number-input" data-index="${index}" data-type="number" placeholder="${field.placeholder}" oninput="handleNumberInput(${index}, this)" onblur="saveInputValue(${index}, this.value)">`;
        } else if (field.type === 'text') {
            return `<input type="text" class="input-blank" data-index="${index}" data-type="text" placeholder="${field.placeholder}" oninput="handleTextInput(${index}, this)" onblur="saveInputValue(${index}, this.value)">`;
        }
        
        return '';
    }
    
    // 获取显示文本（仅用于选择框）
    function getDisplayText(index) {
        if (index >= SelectInResult.length) return "请选择";
        
        const result = SelectInResult[index];
        if (result.type !== 'select' || result.SelectValue.length === 0) {
            return "请选择";
        }
        
        const field = questionData.inputFields[index];
        // SelectValue数组已经按照选项顺序排序，直接使用
        const selectedTexts = result.SelectValue.map(i => {
            const optionLabel = String.fromCharCode(65 + i); // A, B, C, D...
            return `${optionLabel}. ${field.options[i]}`;
        }).filter(Boolean);
        
        return selectedTexts.length > 0 ? selectedTexts.join(', ') : "请选择";
    }
    
    // 处理数字输入
    function handleNumberInput(index, element) {
        const value = element.value;
        // 只允许数字和小数点
        const filteredValue = value.replace(/[^0-9.]/g, '');
        
        // 防止多个小数点
        const parts = filteredValue.split('.');
        if (parts.length > 2) {
            element.value = parts[0] + '.' + parts.slice(1).join('');
        } else {
            element.value = filteredValue;
        }
    }
    
    // 处理文本输入
    function handleTextInput(index, element) {
        // 文本输入不需要特殊处理，允许所有字符
    }
    
    // 保存输入值
    function saveInputValue(index, value) {
        if (index < SelectInResult.length) {
            SelectInResult[index].value = value;
            
            // 持久化存储
            if (Persistence.isAvailable()) {
                Persistence.setItem('SelectInResult', SelectInResult);
            }
            
            const inputType = SelectInResult[index].type;
            updateDebugInfo(`${inputType}输入框${index}输入了: ${value}`);
        }
    }
    
    // 显示下拉菜单
    function showDropdown(index, element) {
        // 关闭其他打开的下拉菜单
        closeAllDropdowns();
        
        const field = questionData.inputFields[index];
        if (!field || field.type !== 'select') return;
        
        const type = field.selectType;
        const isMultiple = type === 'a';
        const options = field.options || [];
        
        // 创建下拉菜单
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-menu';
        dropdown.style.display = 'block';
        
        options.forEach((option, optionIndex) => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            
            const inputType = isMultiple ? 'checkbox' : 'radio';
            const inputName = isMultiple ? `select_${index}` : `select_${index}`;
            const isChecked = SelectInResult[index] && SelectInResult[index].SelectValue.includes(optionIndex);
            
            const optionLabel = String.fromCharCode(65 + optionIndex); // A, B, C, D...
            item.innerHTML = `
                <input type="${inputType}" name="${inputName}" value="${optionIndex}" ${isChecked ? 'checked' : ''}>
                <span>${optionLabel}. ${option}</span>
            `;
            
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const input = item.querySelector('input');
                if (input.type === 'radio') {
                    // 单选：清除所有选择，只选中当前项
                    const allInputs = dropdown.querySelectorAll('input[type="radio"]');
                    allInputs.forEach(inp => inp.checked = false);
                    input.checked = true;
                    SelectInResult[index].SelectValue = [optionIndex];
                    closeAllDropdowns();
                } else {
                    // 多选：切换选择状态
                    input.checked = !input.checked;
                    if (input.checked) {
                        if (!SelectInResult[index].SelectValue.includes(optionIndex)) {
                            SelectInResult[index].SelectValue.push(optionIndex);
                            // 添加后按照选项顺序排序
                            SelectInResult[index].SelectValue.sort((a, b) => a - b);
                        }
                    } else {
                        SelectInResult[index].SelectValue = SelectInResult[index].SelectValue.filter(v => v !== optionIndex);
                        // 移除后数组自然保持排序状态
                    }
                }
                
                const selectedOption = options[optionIndex];
                const selectionType = isMultiple ? '多选' : '单选';
                updateDebugInfo(`${selectionType}框${index}选择了: ${selectedOption}`);
            });
            
            dropdown.appendChild(item);
        });
        
        element.appendChild(dropdown);
        currentOpenDropdown = dropdown;
    }
    
    // 更新所有选择框的显示文本
    function updateAllSelectDisplays() {
        document.querySelectorAll('.select-blank').forEach((element, index) => {
            const dataIndex = parseInt(element.getAttribute('data-index'));
            if (!isNaN(dataIndex) && dataIndex < SelectInResult.length) {
                const result = SelectInResult[dataIndex];
                if (result.type === 'select') {
                    element.textContent = getDisplayText(dataIndex);
                }
            }
        });
    }

    // 关闭所有下拉菜单
    function closeAllDropdowns() {
        const dropdowns = document.querySelectorAll('.dropdown-menu');
        dropdowns.forEach(dropdown => {
            dropdown.style.display = 'none';
            dropdown.remove();
        });
        currentOpenDropdown = null;
        
        // 菜单关闭后更新所有选择框的显示文本
        updateAllSelectDisplays();
        
        // 菜单关闭后进行持久化存储
        if (Persistence.isAvailable()) {
            Persistence.setItem('SelectInResult', SelectInResult);
            updateDebugInfo('菜单关闭，更新显示文本并保存状态');
        } else {
            updateDebugInfo('菜单关闭，更新显示文本（持久化存储不可用）');
        }
    }
    
    // 更新调试信息
    function updateDebugInfo(debugMessage) {
        const debugOutput = document.getElementById('debug-output');
        const currentTime = new Date().toLocaleTimeString();
        
        let displayText;
        if (debugMessage) {
            // 如果有自定义调试信息，显示自定义信息
            displayText = `[${currentTime}] ${debugMessage}`;
        } else {
            // 如果没有自定义信息，显示SelectInResult
            displayText = `[${currentTime}] SelectInResult: ${JSON.stringify(SelectInResult, null, 2)}`;
        }
        
        // 添加新的调试信息到输出区域
        if (debugOutput.textContent.trim() === '') {
            debugOutput.textContent = displayText;
        } else {
            debugOutput.textContent += '\n' + displayText;
        }
        
        // 自动滚动到底部
        debugOutput.scrollTop = debugOutput.scrollHeight;
    }
    
    // 添加自定义调试文本
    function addDebugText(text) {
        updateDebugInfo(text);
    }
    
    // 处理问题文本
    function processQuestion(questionText, inputFields) {
        let processed = questionText;
        
        // 替换所有的 __INPUT_X__ 标记
        inputFields.forEach((field, index) => {
            const placeholder = `__INPUT_${index}__`;
            const inputElement = createInputField(field);
            processed = processed.replace(placeholder, inputElement);
        });
        
        return processed;
    }
    
    // 初始化
    function initialize() {
        // 从Anki字段获取数据
        const frontContent = `{{Front}}`.trim();
        
        // 示例数据（如果Front字段为空）
        const exampleData = "你吃<s&b饭&b鱼&b肉&b>吗?我想吃<s&a狗肉&a猪手&a肌肉&a>很好了.还想吃<n>这个，不想吃<t>那个";
        const inputData = frontContent || exampleData;
        
        // 解析数据
        questionData = parseQuestionData(inputData);
        
        // 处理问题文本并显示
        const processedQuestion = processQuestion(questionData.question, questionData.inputFields);
        document.getElementById('question-display').innerHTML = processedQuestion;
        
        // 初始化SelectInResult
        initializeSelectInResult(questionData.inputFields);
        
        // 从持久化存储中恢复状态
        if (Persistence.isAvailable()) {
            const saved = Persistence.getItem('SelectInResult');
            if (saved) {
                SelectInResult = saved;
                // 更新显示
                restoreInputValues();
                updateDebugInfo('从存储中恢复了之前的输入状态');
            } else {
                updateDebugInfo('没有找到之前保存的状态，使用默认值');
            }
        } else {
            updateDebugInfo('持久化存储不可用');
        }
    }
    
    // 恢复输入值
    function restoreInputValues() {
        SelectInResult.forEach((result, index) => {
            if (result.type === 'select') {
                const element = document.querySelector(`.select-blank[data-index="${index}"]`);
                if (element) {
                    element.textContent = getDisplayText(index);
                }
            } else if (result.type === 'number' || result.type === 'text') {
                const element = document.querySelector(`.input-blank[data-index="${index}"]`);
                if (element && result.value) {
                    element.value = result.value;
                }
            }
        });
    }
    
    // 点击页面其他地方关闭下拉菜单
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.select-blank') && !e.target.closest('.dropdown-menu')) {
            closeAllDropdowns();
        }
    });
    
    // 处理调试输入框的回车事件
    document.addEventListener('DOMContentLoaded', () => {
        const debugInput = document.getElementById('debug-input');
        debugInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const text = debugInput.value.trim();
                if (text) {
                    addDebugText(text);
                    debugInput.value = ''; // 清空输入框
                }
            }
        });
    });
    
    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
</script>
