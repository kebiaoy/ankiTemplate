<script>
    // v1.1.8 - https://github.com/SimonLammer/anki-persistence/blob/584396fea9dea0921011671a47a0fdda19265e62/script.js
    if(void 0===window.Persistence){var e="github.com/SimonLammer/anki-persistence/",t="_default";if(window.Persistence_sessionStorage=function(){var i=!1;try{"object"==typeof window.sessionStorage&&(i=!0,this.clear=function(){for(var t=0;t<sessionStorage.length;t++){var i=sessionStorage.key(t);0==i.indexOf(e)&&(sessionStorage.removeItem(i),t--)}},this.setItem=function(i,n){void 0==n&&(n=i,i=t),sessionStorage.setItem(e+i,JSON.stringify(n))},this.getItem=function(i){return void 0==i&&(i=t),JSON.parse(sessionStorage.getItem(e+i))},this.removeItem=function(i){void 0==i&&(i=t),sessionStorage.removeItem(e+i)},this.getAllKeys=function(){for(var t=[],i=Object.keys(sessionStorage),n=0;n<i.length;n++){var s=i[n];0==s.indexOf(e)&&t.push(s.substring(e.length,s.length))}return t.sort()})}catch(n){}this.isAvailable=function(){return i}},window.Persistence_windowKey=function(i){var n=window[i],s=!1;"object"==typeof n&&(s=!0,this.clear=function(){n[e]={}},this.setItem=function(i,s){void 0==s&&(s=i,i=t),n[e][i]=s},this.getItem=function(i){return void 0==i&&(i=t),void 0==n[e][i]?null:n[e][i]},this.removeItem=function(i){void 0==i&&(i=t),delete n[e][i]},this.getAllKeys=function(){return Object.keys(n[e])},void 0==n[e]&&this.clear()),this.isAvailable=function(){return s}},window.Persistence=new Persistence_sessionStorage,Persistence.isAvailable()||(window.Persistence=new Persistence_windowKey("py")),!Persistence.isAvailable()){var i=window.location.toString().indexOf("title"),n=window.location.toString().indexOf("main",i);i>0&&n>0&&n-i<10&&(window.Persistence=new Persistence_windowKey("qt"))}}
</script>

<style>
    .select-blank {
        display: inline-block;
        min-width: 50px;
        max-width: 120px;
        padding: 2px 6px;
        border: 2px solid #4A90E2;
        border-radius: 4px;
        background-color: #f8f9fa;
        cursor: pointer;
        text-align: center;
        position: relative;
        height: 24px;
        line-height: 20px;
        margin: 0 1px;
        font-size: 14px;
        vertical-align: middle;
    }
    
    .select-blank:hover {
        background-color: #e3f2fd;
    }
    
    .select-blank.selected {
        background-color: #bbdefb;
    }
    
    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: max-content;
        max-width: 300px;
        width: auto;
        display: none;
        padding: 5px 0;
        white-space: nowrap;
    }
    
    .dropdown-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        white-space: normal;
        word-wrap: break-word;
        min-width: fit-content;
    }
    
    .dropdown-item:hover {
        background-color: #f5f5f5;
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .dropdown-item input[type="checkbox"],
    .dropdown-item input[type="radio"] {
        margin-right: 8px;
    }
    
    .question-container {
        font-size: 16px;
        line-height: 1.6;
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fafafa;
    }
    
    .debug-info {
        margin-top: 20px;
        padding: 10px;
        background-color: #f0f0f0;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
    }
    
    .debug-input {
        width: 100%;
        padding: 5px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-family: monospace;
        font-size: 12px;
    }
    
    .debug-output {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 5px;
        background-color: white;
        white-space: pre-wrap;
    }
    
    .input-blank {
        display: inline-block;
        min-width: 60px;
        max-width: 150px;
        width: auto;
        padding: 2px 6px;
        border: none;
        border-bottom: 2px solid #4A90E2;
        border-radius: 0;
        background-color: transparent;
        font-size: 14px;
        height: 24px;
        line-height: 20px;
        margin: 0 1px;
        vertical-align: middle;
        box-sizing: border-box;
    }
    
    .input-blank:focus {
        outline: none;
        border-bottom-color: #2196F3;
        box-shadow: 0 2px 3px rgba(33, 150, 243, 0.3);
    }
    
    .number-input {
        text-align: center;
    }
</style>


<div id="question-display" class="question-container"></div>
<!--<div id="debug" class="debug-info">-->
<!--    <input type="text" id="debug-input" class="debug-input" placeholder="è¾“å…¥è°ƒè¯•æ–‡æœ¬ï¼ŒæŒ‰å›è½¦æ·»åŠ ">-->
<!--    <div id="debug-output" class="debug-output"></div>-->
<!--</div>-->

<script>
    // å…¨å±€å˜é‡
    let SelectInResult = [];
    let questionData = [];
    let currentOpenDropdown = null;
    
    // HTMLè§£ç å‡½æ•°
    function decodeHtmlEntities(text) {
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    }
    
    // è§£æè¾“å…¥æ•°æ®
    function parseQuestionData(input) {
        // ä¿ç•™åŸå§‹HTMLç»“æ„ï¼Œåªè§£æè¾“å…¥æ¡†æ ‡è®°
        let htmlContent = input;
        const inputFields = [];
        
        // æå–æ‰€æœ‰çš„è½¬ä¹‰è¾“å…¥æ¡†æ ‡è®°
        const inputMatches = [];
        const escapedInputRegex = /&lt;(s&amp;[ab][^&]*(?:&amp;[ab][^&]*)*|n|t)&gt;/g;
        let match;
        while ((match = escapedInputRegex.exec(input)) !== null) {
            // è§£ç è¿™ä¸ªç‰¹å®šçš„è¾“å…¥æ¡†æ ‡è®°
            const decodedMatch = decodeHtmlEntities(match[0]);
            inputMatches.push({
                original: match[0],     // åŸå§‹è½¬ä¹‰æ ¼å¼
                decoded: decodedMatch,  // è§£ç åæ ¼å¼
                content: match[1]       // å†…å®¹éƒ¨åˆ†
            });
        }
        
        inputMatches.forEach((matchInfo, index) => {
            const content = decodeHtmlEntities(matchInfo.content);
            
            if (content.startsWith('s')) {
                // é€‰æ‹©æ¡† s&b... æˆ– s&a...
                const selectContent = content.substring(1); // å»æ‰ 's'
                const type = selectContent[1]; // 'a' æˆ– 'b'
                
                // æå–é€‰é¡¹
                const optionMatches = selectContent.match(/&[ab][^&]+/g) || [];
                const options = optionMatches.map(opt => opt.substring(2)).filter(opt => opt.trim() !== '');
                
                inputFields.push({
                    index: index,
                    type: 'select',
                    selectType: type,
                    options: options,
                    placeholder: 'è¯·é€‰æ‹©'
                });
            } else if (content === 'n') {
                // æ•°å­—è¾“å…¥æ¡†
                inputFields.push({
                    index: index,
                    type: 'number',
                    placeholder: 'è¾“å…¥æ•°å­—'
                });
            } else if (content === 't') {
                // æ–‡æœ¬è¾“å…¥æ¡†
                inputFields.push({
                    index: index,
                    type: 'text',
                    placeholder: 'è¾“å…¥æ–‡æœ¬'
                });
            }
            
            // åœ¨HTMLå†…å®¹ä¸­ç”¨å ä½ç¬¦æ›¿æ¢åŸå§‹çš„è½¬ä¹‰æ ‡è®°
            htmlContent = htmlContent.replace(matchInfo.original, `__INPUT_${index}__`);
        });
        
        return { htmlContent, inputFields };
    }
    
    // åˆå§‹åŒ–SelectInResult
    function initializeSelectInResult(inputFields) {
        SelectInResult = []; // æ¸…ç©º
        
        inputFields.forEach((field, index) => {
            if (field.type === 'select') {
                SelectInResult.push({
                    index: index,
                    type: 'select',
                    selectType: field.selectType,
                    SelectValue: []
                });
            } else if (field.type === 'number') {
                SelectInResult.push({
                    index: index,
                    type: 'number',
                    value: ''
                });
            } else if (field.type === 'text') {
                SelectInResult.push({
                    index: index,
                    type: 'text',
                    value: ''
                });
            }
        });
        
        // æŒä¹…åŒ–å­˜å‚¨åˆå§‹çŠ¶æ€
        if (Persistence.isAvailable()) {
            Persistence.setItem('SelectInResult', SelectInResult);
        }
        
        updateDebugInfo('SelectInResultå·²åˆå§‹åŒ–ï¼Œå…±' + SelectInResult.length + 'ä¸ªè¾“å…¥æ¡†');
    }
    
    // åˆ›å»ºè¾“å…¥æ¡†
    function createInputField(field) {
        const index = field.index;
        
        if (field.type === 'select') {
            const isMultiple = field.selectType === 'a';
            return `<span id="input-${index}" class="select-blank" data-index="${index}" data-type="${field.selectType}" data-multiple="${isMultiple}" onclick="showDropdown(${index}, this)">${getDisplayText(index)}</span>`;
        } else if (field.type === 'number') {
            return `<input id="input-${index}" type="text" class="input-blank number-input" data-index="${index}" data-type="number" placeholder="${field.placeholder}" oninput="handleNumberInput(${index}, this)" onblur="saveInputValue(${index}, this.value)">`;
        } else if (field.type === 'text') {
            return `<input id="input-${index}" type="text" class="input-blank" data-index="${index}" data-type="text" placeholder="${field.placeholder}" oninput="handleTextInput(${index}, this)" onblur="saveInputValue(${index}, this.value)">`;
        }
        
        return '';
    }
    
    // è·å–æ˜¾ç¤ºæ–‡æœ¬ï¼ˆä»…ç”¨äºé€‰æ‹©æ¡†ï¼‰
    function getDisplayText(index) {
        if (index >= SelectInResult.length) return "è¯·é€‰æ‹©";
        
        const result = SelectInResult[index];
        if (result.type !== 'select' || result.SelectValue.length === 0) {
            return "è¯·é€‰æ‹©";
        }
        
        // SelectValueæ•°ç»„å·²ç»æŒ‰ç…§é€‰é¡¹é¡ºåºæ’åºï¼Œç›´æ¥ä½¿ç”¨
        const selectedLabels = result.SelectValue.map(i => {
            return String.fromCharCode(65 + i); // A, B, C, D...
        }).filter(Boolean);
        
        return selectedLabels.length > 0 ? selectedLabels.join(', ') : "è¯·é€‰æ‹©";
    }
    
    // å¤„ç†æ•°å­—è¾“å…¥
    function handleNumberInput(index, element) {
        const value = element.value;
        // åªå…è®¸æ•°å­—å’Œå°æ•°ç‚¹
        const filteredValue = value.replace(/[^0-9.]/g, '');
        
        // é˜²æ­¢å¤šä¸ªå°æ•°ç‚¹
        const parts = filteredValue.split('.');
        if (parts.length > 2) {
            element.value = parts[0] + '.' + parts.slice(1).join('');
        } else {
            element.value = filteredValue;
        }
    }
    
    // å¤„ç†æ–‡æœ¬è¾“å…¥
    function handleTextInput(index, element) {
        // æ–‡æœ¬è¾“å…¥ä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå…è®¸æ‰€æœ‰å­—ç¬¦
    }
    
    // ä¿å­˜è¾“å…¥å€¼
    function saveInputValue(index, value) {
        if (index < SelectInResult.length) {
            SelectInResult[index].value = value;
            
            // æŒä¹…åŒ–å­˜å‚¨
            if (Persistence.isAvailable()) {
                Persistence.setItem('SelectInResult', SelectInResult);
            }
            
            const inputType = SelectInResult[index].type;
            updateDebugInfo(`${inputType}è¾“å…¥æ¡†${index}è¾“å…¥äº†: ${value}`);
        }
    }
    
    // æ˜¾ç¤ºä¸‹æ‹‰èœå•
    function showDropdown(index, element) {
        // å…³é—­å…¶ä»–æ‰“å¼€çš„ä¸‹æ‹‰èœå•
        closeAllDropdowns();
        
        const field = questionData.inputFields[index];
        if (!field || field.type !== 'select') return;
        
        const type = field.selectType;
        const isMultiple = type === 'a';
        const options = field.options || [];
        
        // åˆ›å»ºä¸‹æ‹‰èœå•
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-menu';
        dropdown.style.display = 'block';
        
        options.forEach((option, optionIndex) => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            
            const inputType = isMultiple ? 'checkbox' : 'radio';
            const inputName = isMultiple ? `select_${index}` : `select_${index}`;
            const isChecked = SelectInResult[index] && SelectInResult[index].SelectValue.includes(optionIndex);
            
            const optionLabel = String.fromCharCode(65 + optionIndex); // A, B, C, D...
            item.innerHTML = `
                <input type="${inputType}" name="${inputName}" value="${optionIndex}" ${isChecked ? 'checked' : ''}>
                <span>${optionLabel}. ${option}</span>
            `;
            
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const input = item.querySelector('input');
                if (input.type === 'radio') {
                    // å•é€‰ï¼šæ¸…é™¤æ‰€æœ‰é€‰æ‹©ï¼Œåªé€‰ä¸­å½“å‰é¡¹
                    const allInputs = dropdown.querySelectorAll('input[type="radio"]');
                    allInputs.forEach(inp => inp.checked = false);
                    input.checked = true;
                    SelectInResult[index].SelectValue = [optionIndex];
                    closeAllDropdowns();
                } else {
                    // å¤šé€‰ï¼šåˆ‡æ¢é€‰æ‹©çŠ¶æ€
                    input.checked = !input.checked;
                    if (input.checked) {
                        if (!SelectInResult[index].SelectValue.includes(optionIndex)) {
                            SelectInResult[index].SelectValue.push(optionIndex);
                            // æ·»åŠ åæŒ‰ç…§é€‰é¡¹é¡ºåºæ’åº
                            SelectInResult[index].SelectValue.sort((a, b) => a - b);
                        }
                    } else {
                        SelectInResult[index].SelectValue = SelectInResult[index].SelectValue.filter(v => v !== optionIndex);
                        // ç§»é™¤åæ•°ç»„è‡ªç„¶ä¿æŒæ’åºçŠ¶æ€
                    }
                }
                
                const selectedOption = options[optionIndex];
                const selectionType = isMultiple ? 'å¤šé€‰' : 'å•é€‰';
                updateDebugInfo(`${selectionType}æ¡†${index}é€‰æ‹©äº†: ${selectedOption}`);
            });
            
            dropdown.appendChild(item);
        });
        
        element.appendChild(dropdown);
        
        // åŠ¨æ€è°ƒæ•´ä¸‹æ‹‰èœå•å®½åº¦
        adjustDropdownWidth(dropdown, element);
        
        currentOpenDropdown = dropdown;
    }
    
    // åŠ¨æ€è°ƒæ•´ä¸‹æ‹‰èœå•å®½åº¦
    function adjustDropdownWidth(dropdown, triggerElement) {
        // ä¸´æ—¶æ˜¾ç¤ºä¸‹æ‹‰èœå•ä»¥æµ‹é‡å†…å®¹å®½åº¦
        dropdown.style.visibility = 'hidden';
        dropdown.style.display = 'block';
        dropdown.style.width = 'auto';
        dropdown.style.minWidth = 'max-content';
        
        // è·å–æ‰€æœ‰èœå•é¡¹çš„æœ€å¤§å®½åº¦
        const items = dropdown.querySelectorAll('.dropdown-item');
        let maxWidth = 0;
        
        items.forEach(item => {
            const itemWidth = item.scrollWidth;
            maxWidth = Math.max(maxWidth, itemWidth);
        });
        
        // ç¡®ä¿ä¸‹æ‹‰èœå•ä¸ä¼šæ¯”è§¦å‘å…ƒç´ å°å¤ªå¤šï¼Œä½†ä¹Ÿä¸ä¼šè¿‡å®½
        const triggerWidth = triggerElement.offsetWidth;
        const minMenuWidth = Math.max(triggerWidth, 80); // æœ€å°å®½åº¦ä¸ºè§¦å‘å…ƒç´ å®½åº¦æˆ–80px
        const maxMenuWidth = Math.min(maxWidth + 20, 500); // æœ€å¤§å®½åº¦é™åˆ¶ä¸º300pxï¼ŒåŠ 20pxçš„ç¼“å†²
        
        const finalWidth = Math.max(minMenuWidth, Math.min(maxMenuWidth, maxWidth + 20));
        
        // åº”ç”¨è®¡ç®—å‡ºçš„å®½åº¦
        dropdown.style.width = finalWidth + 'px';
        dropdown.style.minWidth = finalWidth + 'px';
        
        // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè§†å£å³è¾¹ç•Œï¼Œå¦‚æœæ˜¯åˆ™è°ƒæ•´ä½ç½®
        const rect = dropdown.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        
        if (rect.right > viewportWidth) {
            const overflowAmount = rect.right - viewportWidth + 10; // 10pxç¼“å†²
            dropdown.style.left = `-${overflowAmount}px`;
        }
        
        // æ¢å¤æ˜¾ç¤º
        dropdown.style.visibility = 'visible';
    }
    
    // æ›´æ–°æ‰€æœ‰é€‰æ‹©æ¡†çš„æ˜¾ç¤ºæ–‡æœ¬
    function updateAllSelectDisplays() {
        document.querySelectorAll('.select-blank').forEach((element, index) => {
            const dataIndex = parseInt(element.getAttribute('data-index'));
            if (!isNaN(dataIndex) && dataIndex < SelectInResult.length) {
                const result = SelectInResult[dataIndex];
                if (result.type === 'select') {
                    element.textContent = getDisplayText(dataIndex);
                }
            }
        });
    }

    // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
    function closeAllDropdowns() {
        const dropdowns = document.querySelectorAll('.dropdown-menu');
        dropdowns.forEach(dropdown => {
            dropdown.style.display = 'none';
            dropdown.remove();
        });
        if(currentOpenDropdown == null){
            return;
        }
        currentOpenDropdown = null;
        
        // èœå•å…³é—­åæ›´æ–°æ‰€æœ‰é€‰æ‹©æ¡†çš„æ˜¾ç¤ºæ–‡æœ¬
        updateAllSelectDisplays();
        
        // èœå•å…³é—­åè¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨
        if (Persistence.isAvailable()) {
            Persistence.setItem('SelectInResult', SelectInResult);
            updateDebugInfo('èœå•å…³é—­ï¼Œæ›´æ–°æ˜¾ç¤ºæ–‡æœ¬å¹¶ä¿å­˜çŠ¶æ€');
        } else {
            updateDebugInfo('èœå•å…³é—­ï¼Œæ›´æ–°æ˜¾ç¤ºæ–‡æœ¬ï¼ˆæŒä¹…åŒ–å­˜å‚¨ä¸å¯ç”¨ï¼‰');
        }
    }
    
    // æ›´æ–°è°ƒè¯•ä¿¡æ¯
    function updateDebugInfo(debugMessage) {
        // const debugOutput = document.getElementById('debug-output');
        // const currentTime = new Date().toLocaleTimeString();
        //
        // let displayText;
        // if (debugMessage) {
        //     // å¦‚æœæœ‰è‡ªå®šä¹‰è°ƒè¯•ä¿¡æ¯ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰ä¿¡æ¯
        //     displayText = `[${currentTime}] ${debugMessage}`;
        // } else {
        //     // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰ä¿¡æ¯ï¼Œæ˜¾ç¤ºSelectInResult
        //     displayText = `[${currentTime}] SelectInResult: ${JSON.stringify(SelectInResult, null, 2)}`;
        // }
        //
        // // æ·»åŠ æ–°çš„è°ƒè¯•ä¿¡æ¯åˆ°è¾“å‡ºåŒºåŸŸ
        // if (debugOutput.textContent.trim() === '') {
        //     debugOutput.textContent = displayText;
        // } else {
        //     debugOutput.textContent += '\n' + displayText;
        // }
        //
        // // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        // debugOutput.scrollTop = debugOutput.scrollHeight;
    }
    
    // æ·»åŠ è‡ªå®šä¹‰è°ƒè¯•æ–‡æœ¬
    function addDebugText(text) {
        //updateDebugInfo(text);
    }
    
    // å¤„ç†HTMLå†…å®¹
    function processHtmlContent(htmlContent, inputFields) {
        let processed = htmlContent;
        
        // æ›¿æ¢æ‰€æœ‰çš„ __INPUT_X__ æ ‡è®°
        inputFields.forEach((field, index) => {
            const placeholder = `__INPUT_${index}__`;
            const inputElement = createInputField(field);
            processed = processed.replace(placeholder, inputElement);
        });
        
        return processed;
    }
    
    // åˆ›å»ºå¸®åŠ©æ‰‹å†Œ
    function createHelpManual() {
        return `
            <div style="padding: 20px; border: 2px solid #4A90E2; border-radius: 8px; background-color: #f8f9fa; margin: 20px 0;">
                <h3 style="color: #4A90E2; margin-top: 0;">ğŸ“– é€‰æ‹©å¡«ç©ºé¢˜è¾“å…¥æ ¼å¼å¸®åŠ©</h3>
                
                <h4>ğŸ”¤ åŸºæœ¬æ ¼å¼ï¼š</h4>
                <p>åœ¨Ankiçš„HTMLå­—æ®µä¸­ä½¿ç”¨è½¬ä¹‰å­—ç¬¦ï¼š<code>&amp;lt;...&amp;gt;</code> åŒ…è£¹è¾“å…¥æ¡†</p>
                
                <h4>ğŸ“ è¾“å…¥æ¡†ç±»å‹ï¼š</h4>
                <ul>
                    <li><strong>å•é€‰æ¡†ï¼š</strong><code>&amp;lt;s&amp;amp;bé€‰é¡¹1&amp;amp;bé€‰é¡¹2&amp;amp;bé€‰é¡¹3&amp;amp;b&amp;gt;</code></li>
                    <li><strong>å¤šé€‰æ¡†ï¼š</strong><code>&amp;lt;s&amp;amp;aé€‰é¡¹1&amp;amp;aé€‰é¡¹2&amp;amp;aé€‰é¡¹3&amp;amp;a&amp;gt;</code></li>
                    <li><strong>æ•°å­—è¾“å…¥ï¼š</strong><code>&amp;lt;n&amp;gt;</code> ï¼ˆåªèƒ½è¾“å…¥æ•°å­—å’Œå°æ•°ç‚¹ï¼‰</li>
                    <li><strong>æ–‡æœ¬è¾“å…¥ï¼š</strong><code>&amp;lt;t&amp;gt;</code> ï¼ˆå¯è¾“å…¥ä»»ä½•æ–‡æœ¬ï¼‰</li>
                </ul>
                
                <h4>ğŸ’¡ ç¤ºä¾‹ï¼ˆAnkiå­—æ®µä¸­çš„æ ¼å¼ï¼‰ï¼š</h4>
                <div style="background-color: #e3f2fd; padding: 10px; border-radius: 4px; font-family: monospace; word-break: break-all;">
                    &amp;lt;p&amp;gt;ä½ åƒ&amp;lt;s&amp;amp;bé¥­&amp;amp;bé±¼&amp;amp;bè‚‰&amp;amp;b&amp;gt;å—?æˆ‘æƒ³åƒ&amp;lt;s&amp;amp;aç‹—è‚‰&amp;amp;açŒªæ‰‹&amp;amp;aè‚Œè‚‰&amp;amp;a&amp;gt;å¾ˆå¥½äº†.è¿˜æƒ³åƒ&amp;lt;n&amp;gt;è¿™ä¸ªï¼Œä¸æƒ³åƒ&amp;lt;t&amp;gt;é‚£ä¸ª&amp;lt;/p&amp;gt;
                </div>
                
                <h4>ğŸ“‹ æ ¼å¼è¯´æ˜ï¼š</h4>
                <ul>
                    <li><code>&amp;amp;b</code> è¡¨ç¤ºå•é€‰é€‰é¡¹ï¼ˆradioï¼‰</li>
                    <li><code>&amp;amp;a</code> è¡¨ç¤ºå¤šé€‰é€‰é¡¹ï¼ˆcheckboxï¼‰</li>
                    <li><code>&amp;lt;</code> å’Œ <code>&amp;gt;</code> æ˜¯HTMLè½¬ä¹‰çš„ &lt; å’Œ &gt;</li>
                    <li><code>&amp;amp;</code> æ˜¯HTMLè½¬ä¹‰çš„ &amp;</li>
                    <li>é€‰é¡¹ä¼šè‡ªåŠ¨æ·»åŠ  Aã€Bã€C æ ‡ç­¾</li>
                    <li>å¤šé€‰ç»“æœæŒ‰ Aã€Bã€C é¡ºåºæ˜¾ç¤ºå’Œå­˜å‚¨</li>
                </ul>
                
                <h4>ğŸ¯ ä½¿ç”¨æ–¹æ³•ï¼š</h4>
                <p>åœ¨Ankiå¡ç‰‡çš„ <strong>{{Front}}</strong> å­—æ®µä¸­è¾“å…¥ä¸Šè¿°æ ¼å¼çš„æ–‡æœ¬å³å¯</p>
                
                <hr style="margin: 15px 0;">
                <p style="color: #666; font-style: italic; margin-bottom: 0;">
                    ğŸ’¡ æç¤ºï¼šä¸‹æ–¹æ˜¾ç¤ºçš„æ˜¯ç¤ºä¾‹æ•ˆæœï¼Œæ‚¨å¯ä»¥å°è¯•æ“ä½œå„ç§è¾“å…¥æ¡†
                </p>
            </div>
        `;
    }

    // åˆå§‹åŒ–
    function initialize() {
        // ä»Ankiå­—æ®µè·å–æ•°æ®
        const frontContent = `{{Front}}`.trim();
        
        let inputData;
        let showHelp = false;
        
        if (!frontContent) {
            // å¦‚æœFrontå­—æ®µä¸ºç©ºï¼Œæ˜¾ç¤ºå¸®åŠ©æ‰‹å†Œå’Œç¤ºä¾‹
            showHelp = true;
            inputData = '<p>ä½ åƒ&lt;s&amp;bé¥­&amp;bé±¼&amp;bè‚‰&amp;b&gt;å—?æˆ‘æƒ³åƒ&lt;s&amp;aç‹—è‚‰&amp;açŒªæ‰‹&amp;aè‚Œè‚‰&amp;a&gt;å¾ˆå¥½äº†.è¿˜æƒ³åƒ&lt;n&gt;è¿™ä¸ªï¼Œä¸æƒ³åƒ&lt;t&gt;é‚£ä¸ª</p><figure class="image"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjEwMCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+ç¤ºä¾‹å›¾ç‰‡</text></svg>" alt="ç¤ºä¾‹å›¾ç‰‡"></figure>';
        } else {
            inputData = frontContent;
        }
        
        // è§£ææ•°æ®
        questionData = parseQuestionData(inputData);
        
        // æ˜¾ç¤ºå¸®åŠ©æ‰‹å†Œï¼ˆå¦‚æœéœ€è¦ï¼‰
        let displayContent = '';
        if (showHelp) {
            displayContent += createHelpManual();
            displayContent += '<h4>ğŸ“Œ ç¤ºä¾‹æ•ˆæœï¼š</h4>';
        }
        
        // å¤„ç†HTMLå†…å®¹å¹¶æ˜¾ç¤º
        const processedHtml = processHtmlContent(questionData.htmlContent, questionData.inputFields);
        displayContent += processedHtml;
        
        document.getElementById('question-display').innerHTML = displayContent;
        
        // åˆå§‹åŒ–SelectInResult
        initializeSelectInResult(questionData.inputFields);

        // ä»æŒä¹…åŒ–å­˜å‚¨ä¸­æ¢å¤çŠ¶æ€
        if (Persistence.isAvailable()) {
            const saved = Persistence.getItem('SelectInResult');
            if (saved) {
                SelectInResult = saved;
                // æ›´æ–°æ˜¾ç¤º
                restoreInputValues();
                updateDebugInfo('ä»å­˜å‚¨ä¸­æ¢å¤äº†ä¹‹å‰çš„è¾“å…¥çŠ¶æ€');
            } else {
                updateDebugInfo('æ²¡æœ‰æ‰¾åˆ°ä¹‹å‰ä¿å­˜çš„çŠ¶æ€ï¼Œä½¿ç”¨é»˜è®¤å€¼');
            }
        } else {
            updateDebugInfo('æŒä¹…åŒ–å­˜å‚¨ä¸å¯ç”¨');
        }
    }
    
    // æ¢å¤è¾“å…¥å€¼
    function restoreInputValues() {
        SelectInResult.forEach((result, index) => {
            if (result.type === 'select') {
                const element = document.querySelector(`.select-blank[data-index="${index}"]`);
                if (element) {
                    element.textContent = getDisplayText(index);
                }
            } else if (result.type === 'number' || result.type === 'text') {
                const element = document.querySelector(`.input-blank[data-index="${index}"]`);
                if (element && result.value) {
                    element.value = result.value;
                }
            }
        });
    }
    
    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.select-blank') && !e.target.closest('.dropdown-menu')) {
            closeAllDropdowns();
        }
    });
    
    // // å¤„ç†è°ƒè¯•è¾“å…¥æ¡†çš„å›è½¦äº‹ä»¶
    // document.addEventListener('DOMContentLoaded', () => {
    //     const debugInput = document.getElementById('debug-input');
    //     debugInput.addEventListener('keypress', (e) => {
    //         if (e.key === 'Enter') {
    //             const text = debugInput.value.trim();
    //             if (text) {
    //                 addDebugText(text);
    //                 debugInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
    //             }
    //         }
    //     });
    // });
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
</script>
